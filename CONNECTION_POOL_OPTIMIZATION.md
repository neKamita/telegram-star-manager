# üîß Connection Pool Optimization Guide

## üìã –ü—Ä–æ–±–ª–µ–º—ã –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

### 1. **PostgreSQL HikariCP Pool**
- **–î–æ**: max-pool-size=10, min-idle=2
- **–ü–æ—Å–ª–µ**: max-pool-size=3, min-idle=1
- **–≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏**: ~70% –º–µ–Ω—å—à–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

### 2. **Redis Connection Pool**
- **–î–æ**: –ö–æ–Ω—Ñ–ª–∏–∫—Ç jedis/lettuce –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
- **–ü–æ—Å–ª–µ**: –¢–æ–ª—å–∫–æ lettuce —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –°—Ç–∞–±–∏–ª—å–Ω—ã–µ Redis —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

### 3. **HTTP Connection Pool**
- **–î–æ**: RestTemplate –±–µ–∑ pooling (–Ω–æ–≤—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫–∞–∂–¥—ã–π —Ä–∞–∑)
- **–ü–æ—Å–ª–µ**: Apache HttpClient5 —Å connection pooling
- **–≠–∫–æ–Ω–æ–º–∏—è**: max-total=5, max-per-route=2

### 4. **BotSelfTestService**
- **–î–æ**: –°–∞–º–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥
- **–ü–æ—Å–ª–µ**: –ö–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥ —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º RestTemplate
- **–≠–∫–æ–Ω–æ–º–∏—è**: 75% –º–µ–Ω—å—à–µ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤

## üöÄ –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### Connection Pool Monitoring
```bash
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ connection pools
GET /api/monitoring/connection-pools

# Health check
GET /api/monitoring/health

# Spring Actuator endpoints
GET /actuator/health
GET /actuator/metrics
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
- Health checks –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –ü–∞–º—è—Ç—å
- **PostgreSQL Pool**: -100MB (7 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –º–µ–Ω—å—à–µ)
- **HTTP Pool**: -50MB (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π)
- **–û–±—â–∞—è —ç–∫–æ–Ω–æ–º–∏—è**: ~150MB RAM

### CPU
- **–ú–µ–Ω—å—à–µ —Å–æ–∑–¥–∞–Ω–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π**: -30% CPU
- **–†–µ–∂–µ —Å–∞–º–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: -10% CPU
- **–û–±—â–∞—è —ç–∫–æ–Ω–æ–º–∏—è**: ~40% CPU usage

### –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å
- **–ù–µ—Ç —É—Ç–µ—á–µ–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π**: connection pooling —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–æ–π
- **–¢–∞–π–º–∞—É—Ç—ã**: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∑–∞–≤–∏—Å—à–∏—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: —Ä–∞–Ω–Ω–µ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

## üõ†Ô∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ä–µ–¥

### Development (H2 + –±–µ–∑ Redis)
```properties
spring.profiles.active=development
# –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
```

### Production (PostgreSQL + Redis)
```properties
spring.profiles.active=production,postgresql
# Koyeb –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
```

### –ö–∞—Å—Ç–æ–º–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```properties
# Database pool
DB_POOL_SIZE=3
DB_POOL_MIN_IDLE=1

# Redis pool 
REDIS_HOST=localhost
REDIS_PORT=6379

# Self-test
telegram.self-test.delay-seconds=60
```

## üîç Troubleshooting

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ pools
```bash
curl https://your-app.koyeb.app/api/monitoring/connection-pools
```

### –õ–æ–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
```
üìä Database Pool Status:
  üîπ Active: 1
  üîπ Idle: 2
  üîπ Total: 3
  üîπ Waiting: 0
```

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
- **Database waiting > 0**: –Ω–µ—Ö–≤–∞—Ç–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –ë–î
- **Memory usage > 85%**: –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
- **Redis disconnected**: –ø—Ä–æ–±–ª–µ–º—ã —Å Redis

## üîÑ Deployment

1. **–ë–∏–ª–¥ —Å –Ω–æ–≤—ã–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏**:
   ```bash
   mvn clean package -DskipTests
   ```

2. **–î–µ–ø–ª–æ–π –Ω–∞ Koyeb**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ GitHub Actions

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è**:
   ```bash
   curl https://your-app.koyeb.app/actuator/health
   ```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ Production

### –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
- –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö: WARNING –≤ –ª–æ–≥–∞—Ö
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏: Health check failures

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
- `hikari.connections.active`
- `hikari.connections.total`
- `lettuce.pool.active`
- `jvm.memory.used`

–¢–µ–ø–µ—Ä—å –≤–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–∞—Ö Koyeb! üéâ
