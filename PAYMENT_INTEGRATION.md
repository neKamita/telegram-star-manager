# ğŸ”§ Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ - Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ½Ñ‹Ñ… ÑĞ¸ÑÑ‚ĞµĞ¼

## ğŸ“‹ ĞĞ±Ğ·Ğ¾Ñ€

TelegramStarManager Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ñ Ñ‡ĞµÑ‚Ñ‹Ñ€ÑŒĞ¼Ñ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğ¼Ğ¸ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ½Ñ‹Ğ¼Ğ¸ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°Ğ¼Ğ¸:
- **TON Wallet** - ĞºÑ€Ğ¸Ğ¿Ñ‚Ğ¾Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ¸ Ğ½Ğ° Ğ±Ğ»Ğ¾ĞºÑ‡ĞµĞ¹Ğ½Ğµ TON
- **YooKassa** - Ñ€Ğ¾ÑÑĞ¸Ğ¹ÑĞºĞ°Ñ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ½Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°
- **QIWI** - ÑĞ»ĞµĞºÑ‚Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğ¹ ĞºĞ¾ÑˆĞµĞ»ĞµĞº Ğ¸ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ¸
- **SberPay** - Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ½Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ¡Ğ±ĞµÑ€Ğ±Ğ°Ğ½ĞºĞ°

## ğŸ—ï¸ ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ½Ğ¾Ğ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ĞĞ Ğ¥Ğ˜Ğ¢Ğ•ĞšĞ¢Ğ£Ğ Ğ ĞŸĞ›ĞĞ¢Ğ•Ğ–Ğ•Ğ™ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ PaymentService  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ PaymentController   â”‚â”‚
â”‚  â”‚                 â”‚                 â”‚                     â”‚â”‚
â”‚  â”‚ â€¢ createPayment â”‚                 â”‚ â€¢ POST /payment     â”‚â”‚
â”‚  â”‚ â€¢ processPaymentâ”‚                 â”‚ â€¢ GET /status       â”‚â”‚
â”‚  â”‚ â€¢ verifyCallbackâ”‚                 â”‚ â€¢ POST /callback/*  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚           â”‚                                    â”‚            â”‚
â”‚           â–¼                                    â–¼            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ PaymentEntity   â”‚                 â”‚ CallbackHandler     â”‚â”‚
â”‚  â”‚                 â”‚                 â”‚                     â”‚â”‚
â”‚  â”‚ â€¢ ID, amount    â”‚                 â”‚ â€¢ verifySignature   â”‚â”‚
â”‚  â”‚ â€¢ status, methodâ”‚                 â”‚ â€¢ processWebhook    â”‚â”‚
â”‚  â”‚ â€¢ timestamps    â”‚                 â”‚ â€¢ updateStatus      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚           â”‚                                    â”‚            â”‚
â”‚           â–¼                                    â–¼            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ PaymentRepo     â”‚                 â”‚ External APIs       â”‚â”‚
â”‚  â”‚                 â”‚                 â”‚                     â”‚â”‚
â”‚  â”‚ â€¢ findByPaymentIdâ”‚                â”‚ â€¢ TON API          â”‚â”‚
â”‚  â”‚ â€¢ save          â”‚                 â”‚ â€¢ YooKassa API     â”‚â”‚
â”‚  â”‚ â€¢ findExpired   â”‚                 â”‚ â€¢ QIWI API         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚ â€¢ SberPay API      â”‚â”‚
â”‚                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âš™ï¸ ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ

### ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ñ„Ğ°Ğ¹Ğ» ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸
Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ `application-payment.properties`:

```properties
# ============================================
# ĞĞ‘Ğ©Ğ˜Ğ• ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ ĞŸĞ›ĞĞ¢Ğ•Ğ–ĞĞĞ™ Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ«
# ============================================

payment.general.callback-base-url=${PAYMENT_CALLBACK_BASE_URL:https://yourdomain.com}
payment.general.payment-timeout-minutes=30
payment.general.max-retry-attempts=3
payment.general.retry-interval-minutes=5
payment.general.enable-detailed-logging=true
payment.general.callback-secret=${PAYMENT_CALLBACK_SECRET}

# ============================================
# ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ TON WALLET
# ============================================

payment.ton.enabled=${TON_ENABLED:false}
payment.ton.api-key=${TON_API_KEY:}
payment.ton.secret-key=${TON_SECRET_KEY:}
payment.ton.api-url=${TON_API_URL:https://toncenter.com/api/v3}
payment.ton.webhook-url=${TON_WEBHOOK_URL:}
payment.ton.wallet-address=${TON_WALLET_ADDRESS:}
payment.ton.network-fee-percent=1.0

# ============================================
# ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ YOOKASSA
# ============================================

payment.yookassa.enabled=${YOOKASSA_ENABLED:false}
payment.yookassa.shop-id=${YOOKASSA_SHOP_ID:}
payment.yookassa.secret-key=${YOOKASSA_SECRET_KEY:}
payment.yookassa.api-url=${YOOKASSA_API_URL:https://api.yookassa.ru/v3}
payment.yookassa.webhook-url=${YOOKASSA_WEBHOOK_URL:}
payment.yookassa.auto-capture=true
payment.yookassa.request-timeout-seconds=30

# ============================================
# ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ QIWI
# ============================================

payment.qiwi.enabled=${QIWI_ENABLED:false}
payment.qiwi.public-key=${QIWI_PUBLIC_KEY:}
payment.qiwi.secret-key=${QIWI_SECRET_KEY:}
payment.qiwi.api-url=${QIWI_API_URL:https://api.qiwi.com}
payment.qiwi.webhook-url=${QIWI_WEBHOOK_URL:}
payment.qiwi.site-id=${QIWI_SITE_ID:}
payment.qiwi.default-currency=RUB
payment.qiwi.bill-lifetime-minutes=60

# ============================================
# ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ SBERPAY
# ============================================

payment.sberpay.enabled=${SBERPAY_ENABLED:false}
payment.sberpay.merchant-id=${SBERPAY_MERCHANT_ID:}
payment.sberpay.secret-key=${SBERPAY_SECRET_KEY:}
payment.sberpay.api-url=${SBERPAY_API_URL:https://securepayments.sberbank.ru}
payment.sberpay.webhook-url=${SBERPAY_WEBHOOK_URL:}
payment.sberpay.api-login=${SBERPAY_API_LOGIN:}
payment.sberpay.api-password=${SBERPAY_API_PASSWORD:}
payment.sberpay.test-mode=${SBERPAY_TEST_MODE:true}
payment.sberpay.default-currency-code=643
```

## ğŸ”— API Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸

### 1. TON Wallet Integration

#### Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ° TON:
```http
POST https://toncenter.com/api/v3/wallet/deploy
Authorization: Bearer {TON_API_KEY}
Content-Type: application/json

{
  "address": "{TON_WALLET_ADDRESS}",
  "amount": "{amount_in_nanotons}",
  "payload": "{payment_id}",
  "callback_url": "{CALLBACK_URL}/ton"
}
```

#### Webhook Ğ¾Ñ‚ TON:
```json
{
  "transaction_id": "12345678",
  "from_address": "EQD...",
  "to_address": "EQB...", 
  "amount": "1000000000",
  "payload": "PAY_1734012345_7892",
  "timestamp": 1734012345,
  "signature": "abc123..."
}
```

#### Ğ’ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸ TON:
```java
private boolean verifyTonSignature(String payload, String signature, String secretKey) {
    try {
        Mac mac = Mac.getInstance("HmacSHA256");
        SecretKeySpec secretKeySpec = new SecretKeySpec(secretKey.getBytes(), "HmacSHA256");
        mac.init(secretKeySpec);
        
        byte[] hash = mac.doFinal(payload.getBytes());
        String expectedSignature = Base64.getEncoder().encodeToString(hash);
        
        return MessageDigest.isEqual(signature.getBytes(), expectedSignature.getBytes());
    } catch (Exception e) {
        log.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸ TON: {}", e.getMessage());
        return false;
    }
}
```

### 2. YooKassa Integration

#### Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ° YooKassa:
```http
POST https://api.yookassa.ru/v3/payments
Authorization: Basic {base64(shop_id:secret_key)}
Idempotence-Key: {payment_id}
Content-Type: application/json

{
  "amount": {
    "value": "100.00",
    "currency": "RUB"
  },
  "confirmation": {
    "type": "redirect",
    "return_url": "https://yourdomain.com/payment/return"
  },
  "description": "ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°",
  "metadata": {
    "payment_id": "PAY_1734012345_7892",
    "user_id": "123456789"
  }
}
```

#### Webhook Ğ¾Ñ‚ YooKassa:
```json
{
  "type": "notification",
  "event": "payment.succeeded",
  "object": {
    "id": "abc123-def456",
    "status": "succeeded",
    "amount": {
      "value": "100.00",
      "currency": "RUB"
    },
    "metadata": {
      "payment_id": "PAY_1734012345_7892",
      "user_id": "123456789"
    },
    "created_at": "2024-12-12T12:30:45.123Z"
  }
}
```

#### Ğ’ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ webhook YooKassa:
```java
private boolean verifyYooKassaWebhook(String payload, String signature, String secretKey) {
    try {
        Mac mac = Mac.getInstance("HmacSHA256");
        SecretKeySpec secretKeySpec = new SecretKeySpec(secretKey.getBytes(), "HmacSHA256");
        mac.init(secretKeySpec);
        
        byte[] hash = mac.doFinal(payload.getBytes());
        String expectedSignature = Hex.encodeHexString(hash);
        
        return MessageDigest.isEqual(signature.getBytes(), expectedSignature.getBytes());
    } catch (Exception e) {
        log.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ YooKassa webhook: {}", e.getMessage());
        return false;
    }
}
```

### 3. QIWI Integration

#### Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ÑÑ‡ĞµÑ‚Ğ° QIWI:
```http
PUT https://api.qiwi.com/partner/bill/v1/bills/{payment_id}
Authorization: Bearer {QIWI_SECRET_KEY}
Content-Type: application/json

{
  "amount": {
    "currency": "RUB",
    "value": "100.00"
  },
  "comment": "ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°",
  "expirationDateTime": "2024-12-12T13:30:00+03:00",
  "customer": {
    "email": "user@example.com"
  },
  "customFields": {
    "paySourcesFilter": "card,qw"
  }
}
```

#### Webhook Ğ¾Ñ‚ QIWI:
```json
{
  "bill": {
    "siteId": "abc123",
    "billId": "PAY_1734012345_7892",
    "amount": {
      "currency": "RUB",
      "value": "100.00"
    },
    "status": {
      "value": "PAID",
      "changedDateTime": "2024-12-12T12:30:45+03:00"
    }
  },
  "version": "1"
}
```

#### Ğ’ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ QIWI webhook:
```java
private boolean verifyQiwiWebhook(String payload, String signature, String secretKey) {
    try {
        Mac mac = Mac.getInstance("HmacSHA256");
        SecretKeySpec secretKeySpec = new SecretKeySpec(secretKey.getBytes(), "HmacSHA256");
        mac.init(secretKeySpec);
        
        byte[] hash = mac.doFinal(payload.getBytes());
        String expectedSignature = Base64.getEncoder().encodeToString(hash);
        
        return MessageDigest.isEqual(signature.getBytes(), expectedSignature.getBytes());
    } catch (Exception e) {
        log.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ QIWI webhook: {}", e.getMessage());
        return false;
    }
}
```

### 4. SberPay Integration

#### Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ğ° SberPay:
```http
POST https://securepayments.sberbank.ru/payment/rest/register.do
Content-Type: application/x-www-form-urlencoded

userName={SBERPAY_API_LOGIN}&
password={SBERPAY_API_PASSWORD}&
orderNumber={payment_id}&
amount={amount_in_kopecks}&
returnUrl=https://yourdomain.com/payment/return&
description=ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°&
jsonParams={"user_id":"123456789"}
```

#### Webhook Ğ¾Ñ‚ SberPay:
```json
{
  "orderNumber": "PAY_1734012345_7892",
  "orderId": "abc123-def456",
  "amount": 10000,
  "currency": "643",
  "orderStatus": 2,
  "actionCode": 0,
  "actionCodeDescription": "Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾",
  "date": "20241212123045",
  "ip": "192.168.1.1"
}
```

## ğŸ” Webhook Endpoints

### ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° callback URL'Ğ¾Ğ²:

```java
@RestController
@RequestMapping("/api/payment/callback")
@Slf4j
public class PaymentCallbackController {
    
    @PostMapping("/ton")
    public ResponseEntity<String> handleTonCallback(
            @RequestBody String payload,
            @RequestHeader("X-TON-Signature") String signature) {
        
        log.info("ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½ TON callback: {}", payload);
        
        if (!verifyTonSignature(payload, signature)) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("Invalid signature");
        }
        
        // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° callback
        return ResponseEntity.ok("OK");
    }
    
    @PostMapping("/yookassa")
    public ResponseEntity<String> handleYooKassaCallback(
            @RequestBody String payload,
            @RequestHeader("X-YooKassa-Signature") String signature) {
        
        log.info("ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½ YooKassa callback: {}", payload);
        
        if (!verifyYooKassaSignature(payload, signature)) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("Invalid signature");
        }
        
        // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° callback
        return ResponseEntity.ok("OK");
    }
    
    @PostMapping("/qiwi")
    public ResponseEntity<String> handleQiwiCallback(
            @RequestBody String payload,
            @RequestHeader("X-Api-Signature-SHA256") String signature) {
        
        log.info("ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½ QIWI callback: {}", payload);
        
        if (!verifyQiwiSignature(payload, signature)) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("Invalid signature");
        }
        
        // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° callback
        return ResponseEntity.ok("OK");
    }
    
    @PostMapping("/sberpay")
    public ResponseEntity<String> handleSberPayCallback(
            @RequestParam Map<String, String> params) {
        
        log.info("ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½ SberPay callback: {}", params);
        
        if (!verifySberPayCallback(params)) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("Invalid data");
        }
        
        // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° callback
        return ResponseEntity.ok("OK");
    }
}
```

## ğŸ›¡ï¸ Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ

### 1. Ğ’ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞµĞ¹
Ğ’ÑĞµ webhook'Ğ¸ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑÑ‚ÑŒÑÑ Ğ½Ğ° Ğ¿Ğ¾Ğ´Ğ»Ğ¸Ğ½Ğ½Ğ¾ÑÑ‚ÑŒ:

```java
@Component
public class WebhookSecurityService {
    
    public boolean verifyWebhookSignature(String provider, String payload, String signature, String secret) {
        return switch (provider.toLowerCase()) {
            case "ton" -> verifyTonSignature(payload, signature, secret);
            case "yookassa" -> verifyYooKassaSignature(payload, signature, secret);
            case "qiwi" -> verifyQiwiSignature(payload, signature, secret);
            case "sberpay" -> verifySberPaySignature(payload, signature, secret);
            default -> {
                log.warn("ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€: {}", provider);
                yield false;
            }
        };
    }
}
```

### 2. Rate Limiting
ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğº callback'Ğ°Ğ¼:

```java
@Component
public class CallbackRateLimiter {
    private final Map<String, List<Long>> requestCounts = new ConcurrentHashMap<>();
    private final int maxRequestsPerMinute = 100;
    
    public boolean isAllowed(String ip) {
        long currentTime = System.currentTimeMillis();
        List<Long> requests = requestCounts.computeIfAbsent(ip, k -> new ArrayList<>());
        
        // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹
        requests.removeIf(time -> currentTime - time > 60000);
        
        if (requests.size() >= maxRequestsPerMinute) {
            return false;
        }
        
        requests.add(currentTime);
        return true;
    }
}
```

### 3. IP Whitelist
ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° IP Ğ°Ğ´Ñ€ĞµÑĞ¾Ğ² Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ½Ñ‹Ñ… ÑĞ¸ÑÑ‚ĞµĞ¼:

```properties
# IP Ğ°Ğ´Ñ€ĞµÑĞ° Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ½Ñ‹Ñ… ÑĞ¸ÑÑ‚ĞµĞ¼ Ğ´Ğ»Ñ whitelist
payment.security.allowed-ips.ton=95.142.46.34,95.142.46.35
payment.security.allowed-ips.yookassa=185.71.76.0/27,185.71.77.0/27
payment.security.allowed-ips.qiwi=79.142.16.0/20,195.189.100.0/22
payment.security.allowed-ips.sberpay=185.71.76.0/27,212.19.125.0/25
```

## ğŸ“Š ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ¸ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

### 1. ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ĞµĞ¹:
```java
@Component
public class PaymentMetrics {
    private final MeterRegistry meterRegistry;
    
    public void recordPaymentAttempt(String provider) {
        meterRegistry.counter("payment.attempts", "provider", provider).increment();
    }
    
    public void recordPaymentSuccess(String provider, double amount) {
        meterRegistry.counter("payment.success", "provider", provider).increment();
        meterRegistry.counter("payment.amount", "provider", provider).increment(amount);
    }
    
    public void recordPaymentFailure(String provider, String reason) {
        meterRegistry.counter("payment.failures", 
            "provider", provider, "reason", reason).increment();
    }
}
```

### 2. Structured logging:
```java
@Slf4j
public class PaymentLogger {
    
    public void logPaymentCreated(PaymentEntity payment) {
        log.info("payment_created user_id={} payment_id={} amount={} method={}", 
            payment.getUserId(), payment.getPaymentId(), 
            payment.getAmount(), payment.getPaymentMethod());
    }
    
    public void logPaymentCompleted(PaymentEntity payment) {
        log.info("payment_completed user_id={} payment_id={} amount={} method={} duration={}ms", 
            payment.getUserId(), payment.getPaymentId(), 
            payment.getAmount(), payment.getPaymentMethod(),
            ChronoUnit.MILLIS.between(payment.getCreatedAt(), payment.getUpdatedAt()));
    }
    
    public void logWebhookReceived(String provider, String paymentId) {
        log.info("webhook_received provider={} payment_id={}", provider, paymentId);
    }
}
```

## ğŸ”„ Retry Logic

### ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ½ĞµÑƒĞ´Ğ°Ñ‡Ğ½Ñ‹Ñ… callback'Ğ¾Ğ²:
```java
@Service
public class PaymentRetryService {
    
    @Retryable(value = {Exception.class}, maxAttempts = 3, backoff = @Backoff(delay = 5000))
    public void processPaymentCallback(String paymentId, Map<String, String> data) {
        try {
            PaymentEntity payment = paymentRepository.findByPaymentId(paymentId)
                .orElseThrow(() -> new PaymentNotFoundException("Payment not found: " + paymentId));
            
            // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° callback
            processSuccessfulPayment(payment);
            
        } catch (Exception e) {
            log.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ callback Ğ´Ğ»Ñ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ° {}: {}", paymentId, e.getMessage());
            throw e; // Ğ”Ğ»Ñ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ¹ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸
        }
    }
    
    @Recover
    public void recoverFromFailedCallback(Exception ex, String paymentId, Map<String, String> data) {
        log.error("Ğ˜ÑÑ‡ĞµÑ€Ğ¿Ğ°Ğ½Ñ‹ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ callback Ğ´Ğ»Ñ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ° {}: {}", paymentId, ex.getMessage());
        
        // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ
        notificationService.sendAdminAlert("Failed payment callback", paymentId, ex.getMessage());
    }
}
```

## ğŸ§ª Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

### 1. Unit Ñ‚ĞµÑÑ‚Ñ‹ Ğ´Ğ»Ñ Ğ²ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸:
```java
@ExtendWith(MockitoExtension.class)
class PaymentServiceTest {
    
    @Test
    void shouldVerifyTonSignature() {
        String payload = "{\"payment_id\":\"TEST_123\",\"amount\":\"100\"}";
        String secret = "test-secret";
        String validSignature = generateTonSignature(payload, secret);
        
        assertTrue(paymentService.verifyTonSignature(payload, validSignature, secret));
    }
    
    @Test
    void shouldRejectInvalidSignature() {
        String payload = "{\"payment_id\":\"TEST_123\",\"amount\":\"100\"}";
        String secret = "test-secret";
        String invalidSignature = "invalid-signature";
        
        assertFalse(paymentService.verifyTonSignature(payload, invalidSignature, secret));
    }
}
```

### 2. Integration Ñ‚ĞµÑÑ‚Ñ‹:
```java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
class PaymentIntegrationTest {
    
    @Test
    void shouldHandleValidTonCallback() {
        String validPayload = createValidTonCallback();
        String validSignature = generateTonSignature(validPayload, tonSecret);
        
        ResponseEntity<String> response = testRestTemplate.postForEntity(
            "/api/payment/callback/ton",
            createCallbackRequest(validPayload, validSignature),
            String.class
        );
        
        assertEquals(HttpStatus.OK, response.getStatusCode());
        assertEquals("OK", response.getBody());
    }
}
```

## ğŸš¨ Troubleshooting

### Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹:

#### 1. ĞĞµĞ²ĞµÑ€Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑŒ webhook
```
ĞÑˆĞ¸Ğ±ĞºĞ°: HTTP 401 - Invalid signature
Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ: 
- ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑĞµĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğ¹ ĞºĞ»ÑÑ‡
- Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ÑŒÑÑ Ğ² Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ°Ğ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸
- ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ´Ğ¸Ñ€Ğ¾Ğ²ĞºÑƒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
```

#### 2. Timeout Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ĞµĞ¹
```
ĞÑˆĞ¸Ğ±ĞºĞ°: Payment timeout (>30 Ğ¼Ğ¸Ğ½ÑƒÑ‚)
Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:
- ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑĞ²ÑĞ·ÑŒ Ñ API Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ½Ğ¾Ğ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹
- Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ñ‚ÑŒ timeout Ğ² ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸
- ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ² Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğ¼ ĞºĞ°Ğ±Ğ¸Ğ½ĞµÑ‚Ğµ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ğ°
```

#### 3. Ğ”ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ĞµĞ¹
```
ĞÑˆĞ¸Ğ±ĞºĞ°: Duplicate payment processing
Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:
- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ idempotency key
- ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ payment_id
- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ¸ Ğ½Ğ° ÑƒÑ€Ğ¾Ğ²Ğ½Ğµ Ğ‘Ğ”
```

### ĞÑ‚Ğ»Ğ°Ğ´ĞºĞ°:
```bash
# Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
export PAYMENT_DEBUG=true
export LOGGING_LEVEL_SHIT_BACK_SERVICE_PAYMENT=DEBUG

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ webhook endpoint
curl -X POST https://yourdomain.com/api/payment/callback/test \
  -H "Content-Type: application/json" \
  -d '{"test": "data"}'

# ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ»Ğ¾Ğ³Ğ¾Ğ²
tail -f logs/payment.log | grep -E "(payment_|webhook_)"
```

---

*ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½ĞµĞµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: 12 Ğ´ĞµĞºĞ°Ğ±Ñ€Ñ 2024*