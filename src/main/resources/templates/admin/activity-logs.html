<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org" th:replace="~{admin/layout :: layout(~{::title}, ~{::main})}">
<head>
    <title th:text="${title}">Activity Logs</title>
</head>
<body>
<main>
    <!-- Page Header -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <div>
            <h1 class="h2" th:text="${title}">Activity Logs</h1>
            <p class="text-muted mb-0" th:text="${subtitle}">Real-time User Activity & Payment Status Dashboard</p>
        </div>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <button type="button" class="btn btn-outline-secondary" id="toggleShowAll">
                    <i class="fas fa-eye"></i>
                    <span th:text="${showAll} ? 'Show Key Only' : 'Show All Logs'">Show All Logs</span>
                </button>
                <button type="button" class="btn btn-outline-primary" id="pauseStream">
                    <i class="fas fa-pause"></i>
                    <span>Pause Stream</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Summary Cards -->
    <div class="row mb-4" th:if="${activityStats}">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-0">Total Activities</h6>
                            <h4 class="mb-0" th:text="${activityStats.totalActivities}">0</h4>
                        </div>
                        <i class="fas fa-chart-line fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-0">Key Activities</h6>
                            <h4 class="mb-0" th:text="${activityStats.keyActivities}">0</h4>
                        </div>
                        <i class="fas fa-key fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-0">Live Feed</h6>
                            <h4 class="mb-0"><span id="liveActivitiesCount">0</span></h4>
                        </div>
                        <i class="fas fa-broadcast-tower fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-0">Period</h6>
                            <h4 class="mb-0" th:text="${activityStats.periodHours + 'h'}">24h</h4>
                        </div>
                        <i class="fas fa-clock fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content: 3-Column Layout -->
    <div class="row">
        <!-- Left Column: Filters -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-filter"></i> Filters
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="searchInput" class="form-label">Search</label>
                        <input type="text" class="form-control" id="searchInput" 
                               placeholder="Username, order ID..." th:value="${search}">
                    </div>
                    <button type="button" class="btn btn-primary w-100" id="applyFilters">
                        <i class="fas fa-search"></i> Apply Filters
                    </button>
                </div>
            </div>

            <!-- Payment Status Summary -->
            <div class="card mt-3" th:if="${paymentDashboard}">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-credit-card"></i> Payment Status
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-2">
                            <div class="badge bg-success p-2 w-100">
                                <div>‚úÖ Completed</div>
                                <div class="h6 mb-0" th:text="${#lists.size(paymentDashboard.completedPayments)}">0</div>
                            </div>
                        </div>
                        <div class="col-6 mb-2">
                            <div class="badge bg-warning p-2 w-100">
                                <div>‚è≥ Pending</div>
                                <div class="h6 mb-0" th:text="${#lists.size(paymentDashboard.pendingPayments)}">0</div>
                            </div>
                        </div>
                        <div class="col-6 mb-2">
                            <div class="badge bg-danger p-2 w-100">
                                <div>‚ùå Failed</div>
                                <div class="h6 mb-0" th:text="${#lists.size(paymentDashboard.failedPayments)}">0</div>
                            </div>
                        </div>
                        <div class="col-6 mb-2">
                            <div class="badge bg-secondary p-2 w-100">
                                <div>üö´ Cancelled</div>
                                <div class="h6 mb-0" th:text="${#lists.size(paymentDashboard.cancelledOrders)}">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Center Column: Activity Feed -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-stream"></i> Live Activity Feed
                        <span class="badge bg-success ms-2" id="connectionStatus">Connecting...</span>
                    </h5>
                    <small class="text-muted">Real-time updates</small>
                </div>
                <div class="card-body p-0">
                    <div id="activityFeed" style="height: 500px; overflow-y: auto;">
                        <div class="p-3 text-center text-muted" id="loadingMessage">
                            <i class="fas fa-spinner fa-spin"></i> Connecting to live feed...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Recent Activities -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-history"></i> Recent Activities
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" style="max-height: 500px; overflow-y: auto;">
                        <div class="list-group-item py-2" th:each="activity : ${#lists.size(activities.content) > 0 ? activities.content.subList(0, T(java.lang.Math).min(10, activities.content.size())) : {}}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-1">
                                        <span th:text="${activity.actionIcon}" class="me-2">üìù</span>
                                        <strong th:text="${activity.displayName}" class="small">User</strong>
                                        <span th:if="${activity.isKeyAction}" class="badge bg-warning ms-1 small">KEY</span>
                                    </div>
                                    <div class="text-muted small" th:text="${activity.actionDescription}">Action</div>
                                </div>
                                <div class="text-end">
                                    <div class="badge bg-secondary small" th:text="${activity.formattedTimestamp}">Time</div>
                                </div>
                            </div>
                        </div>
                        <div th:if="${#lists.isEmpty(activities.content)}" class="list-group-item text-center text-muted py-3">
                            <i class="fas fa-inbox"></i><br>
                            <small>No recent activities</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Historical Activities Table -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-history"></i> Historical Activities
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>User</th>
                            <th>Action</th>
                            <th>Details</th>
                            <th>Order Info</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="activity : ${activities.content}" 
                            th:class="'table-' + ${activity.priorityClass}">
                            <td>
                                <span class="badge bg-secondary" th:text="${activity.formattedTimestamp}">Time</span>
                            </td>
                            <td>
                                <div th:text="${activity.displayName}">User</div>
                                <small class="text-muted" th:if="${activity.username}" th:text="'@' + ${activity.username}">@username</small>
                            </td>
                            <td>
                                <span th:text="${activity.actionDisplayName}" class="badge bg-primary">Action</span>
                                <span th:if="${activity.isKeyAction}" class="badge bg-warning ms-1">KEY</span>
                            </td>
                            <td th:text="${activity.actionDescription}">Description</td>
                            <td>
                                <span th:if="${activity.orderId}" th:text="${activity.orderDisplayInfo}">Order</span>
                                <span th:unless="${activity.orderId}" class="text-muted">-</span>
                            </td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(activities.content)}">
                            <td colspan="5" class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                No activities found
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <nav th:if="${activities.totalPages > 1}">
                <ul class="pagination justify-content-center">
                    <li class="page-item" th:classappend="${!activities.hasPrevious()} ? 'disabled'">
                        <a class="page-link" th:href="@{/admin/activity-logs(page=${activities.number - 1}, showAll=${showAll}, search=${search})}">Previous</a>
                    </li>
                    
                    <li class="page-item" th:each="i : ${#numbers.sequence(0, activities.totalPages - 1)}"
                        th:classappend="${i == activities.number} ? 'active'">
                        <a class="page-link" th:href="@{/admin/activity-logs(page=${i}, showAll=${showAll}, search=${search})}" th:text="${i + 1}">1</a>
                    </li>
                    
                    <li class="page-item" th:classappend="${!activities.hasNext()} ? 'disabled'">
                        <a class="page-link" th:href="@{/admin/activity-logs(page=${activities.number + 1}, showAll=${showAll}, search=${search})}">Next</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <!-- JavaScript for Real-time functionality -->
    <script>
        let eventSource = null;
        let isStreamPaused = false;
        let activityBuffer = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeActivityStream();
            setupEventHandlers();
        });
        
        function initializeActivityStream() {
            if (!isStreamPaused) {
                connectToActivityStream();
            }
        }
        
        function connectToActivityStream() {
            const statusElement = document.getElementById('connectionStatus');
            const loadingElement = document.getElementById('loadingMessage');
            
            try {
                eventSource = new EventSource('/admin/api/activity-stream');
                
                eventSource.onopen = function(event) {
                    statusElement.textContent = 'Connected';
                    statusElement.className = 'badge bg-success ms-2';
                    if (loadingElement) {
                        loadingElement.style.display = 'none';
                    }
                };
                
                eventSource.onmessage = function(event) {
                    try {
                        const activity = JSON.parse(event.data);
                        addActivityToFeed(activity);
                        updateLiveCounter();
                    } catch (e) {
                        console.error('Error parsing activity data:', e);
                    }
                };
                
                eventSource.addEventListener('activity', function(event) {
                    try {
                        const activity = JSON.parse(event.data);
                        addActivityToFeed(activity);
                        updateLiveCounter();
                    } catch (e) {
                        console.error('Error parsing activity event:', e);
                    }
                });
                
                eventSource.onerror = function(event) {
                    statusElement.textContent = 'Disconnected';
                    statusElement.className = 'badge bg-danger ms-2';
                    
                    setTimeout(() => {
                        if (!isStreamPaused) {
                            connectToActivityStream();
                        }
                    }, 5000);
                };
                
            } catch (error) {
                console.error('Error connecting to activity stream:', error);
                statusElement.textContent = 'Error';
                statusElement.className = 'badge bg-danger ms-2';
            }
        }
        
        function addActivityToFeed(activity) {
            const feed = document.getElementById('activityFeed');
            const loadingMessage = document.getElementById('loadingMessage');
            
            if (loadingMessage) {
                loadingMessage.style.display = 'none';
            }
            
            const activityElement = createActivityElement(activity);
            
            if (feed.firstChild && feed.firstChild.id !== 'loadingMessage') {
                feed.insertBefore(activityElement, feed.firstChild);
            } else {
                feed.appendChild(activityElement);
            }
            
            const activities = feed.children;
            if (activities.length > 50) {
                feed.removeChild(activities[activities.length - 1]);
            }
            
            activityBuffer.unshift(activity);
            if (activityBuffer.length > 100) {
                activityBuffer = activityBuffer.slice(0, 100);
            }
        }
        
        function createActivityElement(activity) {
            const div = document.createElement('div');
            div.className = 'border-bottom p-3 activity-item';
            
            const keyBadge = activity.isKeyAction ? '<span class="badge bg-warning ms-1">KEY</span>' : '';
            
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                            <span class="me-2">${activity.actionIcon || 'üìù'}</span>
                            <strong>${activity.displayName || 'Unknown User'}</strong>
                            <span class="badge bg-secondary ms-2">${activity.formattedTimestamp || 'Now'}</span>
                            ${keyBadge}
                        </div>
                        <div class="text-muted small">${activity.actionDescription || 'No description'}</div>
                        ${activity.orderInfo ? `<div class="small text-info">${activity.orderInfo}</div>` : ''}
                    </div>
                </div>
            `;
            
            div.style.opacity = '0';
            div.style.transform = 'translateY(-10px)';
            
            setTimeout(() => {
                div.style.transition = 'all 0.3s ease';
                div.style.opacity = '1';
                div.style.transform = 'translateY(0)';
            }, 50);
            
            return div;
        }
        
        function updateLiveCounter() {
            const counter = document.getElementById('liveActivitiesCount');
            if (counter) {
                counter.textContent = activityBuffer.length;
            }
        }
        
        function setupEventHandlers() {
            const toggleBtn = document.getElementById('toggleShowAll');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', function() {
                    const showAll = [[${showAll}]];
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.set('showAll', !showAll);
                    window.location.href = newUrl.toString();
                });
            }
            
            const pauseBtn = document.getElementById('pauseStream');
            if (pauseBtn) {
                pauseBtn.addEventListener('click', function() {
                    isStreamPaused = !isStreamPaused;
                    const icon = pauseBtn.querySelector('i');
                    const text = pauseBtn.querySelector('span');
                    
                    if (isStreamPaused) {
                        if (eventSource) {
                            eventSource.close();
                        }
                        icon.className = 'fas fa-play';
                        text.textContent = 'Resume Stream';
                        pauseBtn.className = 'btn btn-outline-success';
                    } else {
                        connectToActivityStream();
                        icon.className = 'fas fa-pause';
                        text.textContent = 'Pause Stream';
                        pauseBtn.className = 'btn btn-outline-primary';
                    }
                });
            }
            
            const applyBtn = document.getElementById('applyFilters');
            if (applyBtn) {
                applyBtn.addEventListener('click', function() {
                    const url = new URL(window.location);
                    
                    const search = document.getElementById('searchInput').value;
                    if (search) {
                        url.searchParams.set('search', search);
                    } else {
                        url.searchParams.delete('search');
                    }
                    
                    url.searchParams.set('page', '0');
                    window.location.href = url.toString();
                });
            }
        }
        
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</main>
</body>
</html>