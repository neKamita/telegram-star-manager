<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{admin/layout :: head}">
    <title>Dashboard - Admin Panel</title>
</head>
<body>
    <div th:replace="~{admin/layout :: body}">
        <div th:fragment="content">
        
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="stats-icon text-primary">
                        <i class="fas fa-flag"></i>
                    </div>
                    <h3 class="h4 mb-1" th:text="${totalFlags ?: 0}">0</h3>
                    <p class="text-muted mb-0">Total Flags</p>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="stats-icon text-success">
                        <i class="fas fa-toggle-on"></i>
                    </div>
                    <h3 class="h4 mb-1" th:text="${activeFlagsCount ?: 0}">0</h3>
                    <p class="text-muted mb-0">Active Flags</p>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="stats-icon text-info">
                        <i class="fas fa-memory"></i>
                    </div>
                    <h3 class="h4 mb-1" th:text="${cacheSize ?: 0}">0</h3>
                    <p class="text-muted mb-0">Cache Size</p>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="stats-icon text-warning">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3 class="h4 mb-1" id="userCount" th:text="${activeUsersCount ?: 0}">0</h3>
                    <p class="text-muted mb-0">Active Users</p>
                </div>
            </div>
        </div>
        
        <!-- Recent Activity -->
        <div class="row">
            <div class="col-lg-8 mb-4">
                <div class="feature-flag-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <i class="fas fa-history text-primary me-2"></i>
                            Recent Activity
                        </h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <input type="radio" class="btn-check" name="activityFilter" id="filterAll" checked>
                            <label class="btn btn-outline-primary" for="filterAll">All</label>
                            
                            <input type="radio" class="btn-check" name="activityFilter" id="filterOrders">
                            <label class="btn btn-outline-success" for="filterOrders">
                                <i class="fas fa-shopping-cart me-1"></i>
                                Orders (<span id="orderCount" th:text="${combinedActivity?.orderCount ?: 0}">0</span>)
                            </label>
                            
                            <input type="radio" class="btn-check" name="activityFilter" id="filterFlags">
                            <label class="btn btn-outline-info" for="filterFlags">
                                <i class="fas fa-flag me-1"></i>
                                Flags (<span id="flagCount" th:text="${combinedActivity?.flagCount ?: 0}">0</span>)
                            </label>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="activityTableBody">
                            <tr th:each="activity : ${combinedActivity?.activities}" 
                                class="activity-row" 
                                th:data-type="${activity.type}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i th:class="${activity.icon} + ' me-2 ' + (${activity.type == 'ORDER'} ? 'text-success' : 'text-primary')"></i>
                                        <span class="fw-bold" th:text="${activity.type == 'ORDER' ? 'Purchase' : 'Flag'}">Type</span>
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <div class="activity-title" th:text="${activity.title}">Title</div>
                                        <small class="text-muted" th:text="${activity.description}">Description</small>
                                    </div>
                                </td>
                                <td>
                                    <span th:class="${activity.badgeClass}" th:text="${activity.badgeText}">Status</span>
                                </td>
                                <td>
                                    <small class="text-muted" th:text="${#temporals.format(activity.timestamp, 'dd.MM.yyyy HH:mm')}">
                                        01.01.2024 12:00
                                    </small>
                                </td>
                                <td>
                                    <a th:href="${activity.actionUrl}" 
                                       class="btn btn-sm btn-outline-secondary" 
                                       th:title="${activity.type == 'ORDER' ? 'View Order' : 'Edit Flag'}">
                                        <i th:class="${activity.type == 'ORDER' ? 'fas fa-eye' : 'fas fa-edit'}"></i>
                                    </a>
                                </td>
                            </tr>
                            
                            <!-- Empty state -->
                            <tr th:if="${combinedActivity == null or #lists.isEmpty(combinedActivity.activities)}" id="emptyState">
                                <td colspan="5" class="text-center py-4">
                                    <i class="fas fa-history fa-2x text-muted mb-3"></i>
                                    <p class="text-muted mb-3">No recent activity found</p>
                                    <div>
                                        <a href="/admin/feature-flags/new" class="btn btn-primary me-2">
                                            <i class="fas fa-plus me-2"></i>
                                            Create Flag
                                        </a>
                                        <a href="/admin/orders" class="btn btn-success">
                                            <i class="fas fa-shopping-cart me-2"></i>
                                            View Orders
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3 pt-3 border-top" th:if="${combinedActivity != null and combinedActivity.totalActivities > 0}">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                Showing <span th:text="${combinedActivity.totalActivities}">0</span> recent activities
                            </small>
                            <div>
                                <a href="/admin/orders" class="btn btn-sm btn-outline-success me-2">
                                    View All Orders
                                    <i class="fas fa-arrow-right ms-1"></i>
                                </a>
                                <a href="/admin/feature-flags" class="btn btn-sm btn-outline-primary">
                                    View All Flags
                                    <i class="fas fa-arrow-right ms-1"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4 mb-4">
                <!-- Quick Actions -->
                <div class="feature-flag-card">
                    <h5 class="mb-3">
                        <i class="fas fa-bolt text-warning me-2"></i>
                        Quick Actions
                    </h5>
                    
                    <div class="d-grid gap-2">
                        <a href="/admin/feature-flags/new" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>
                            Create New Flag
                        </a>
                        
                        <button class="btn btn-outline-secondary" onclick="refreshCache()">
                            <i class="fas fa-sync-alt me-2"></i>
                            Refresh Cache
                        </button>
                        
                        <a href="/admin/monitoring" class="btn btn-outline-info">
                            <i class="fas fa-chart-line me-2"></i>
                            View Monitoring
                        </a>
                        
                        <button class="btn btn-outline-warning" onclick="exportConfig()">
                            <i class="fas fa-download me-2"></i>
                            Export Config
                        </button>
                    </div>
                </div>
                
                <!-- System Status -->
                <div class="feature-flag-card mt-4">
                    <h5 class="mb-3">
                        <i class="fas fa-server text-info me-2"></i>
                        System Status
                    </h5>
                    
                    <div class="row text-center" id="systemStatusIndicators">
                        <div class="col-6 mb-3">
                            <div class="status-indicator bg-secondary rounded-circle mx-auto mb-2" 
                                 style="width: 20px; height: 20px;" id="apiStatus"></div>
                            <small class="text-muted d-block">API</small>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="status-indicator bg-secondary rounded-circle mx-auto mb-2" 
                                 style="width: 20px; height: 20px;" id="redisStatus"></div>
                            <small class="text-muted d-block">Redis</small>
                        </div>
                        <div class="col-6">
                            <div class="status-indicator bg-secondary rounded-circle mx-auto mb-2" 
                                 style="width: 20px; height: 20px;" id="botStatus"></div>
                            <small class="text-muted d-block">Bot</small>
                        </div>
                        <div class="col-6">
                            <div class="status-indicator bg-secondary rounded-circle mx-auto mb-2" 
                                 style="width: 20px; height: 20px;" id="cacheStatus"></div>
                            <small class="text-muted d-block">Cache</small>
                        </div>
                    </div>
                    
                    <!-- Health Score -->
                    <div class="mt-3 text-center">
                        <small class="text-muted">Health Score:</small>
                        <div class="progress mt-1" style="height: 8px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: 0%" id="healthScoreBar"></div>
                        </div>
                        <small class="text-muted" id="healthScoreText">Loading...</small>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>
    
    <!-- Page Scripts -->
    <script th:fragment="scripts">
        // Dashboard Variables
        let refreshInterval;
        let isRefreshing = false;

        // DOM Ready
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            updateSystemStatus();
            startAutoRefresh();
            setupEventListeners();
        });

        // Initialize Dashboard
        function initializeDashboard() {
            console.log('Dashboard initialized');
            loadDashboardData();
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Toggle Flag Buttons
            document.querySelectorAll('.toggle-flag-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const flagName = this.getAttribute('data-flag-name');
                    toggleFlag(flagName);
                });
            });

            // Activity Filter Buttons
            document.querySelectorAll('input[name="activityFilter"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    filterActivities(this.id);
                });
            });

            // Sidebar Toggle for Mobile
            const sidebarToggle = document.getElementById('sidebarToggle');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    document.querySelector('.sidebar').classList.toggle('show');
                });
            }
        }

        // Load Dashboard Data
        function loadDashboardData() {
            if (isRefreshing) return;
            
            isRefreshing = true;
            const refreshBtn = document.querySelector('[onclick="refreshData()"]');
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<i class="fas fa-spin fa-sync-alt"></i> Refreshing...';
            }

            fetch('/admin/api/dashboard-data')
                .then(response => response.json())
                .then(data => {
                    updateDashboardData(data);
                    showSuccess('Dashboard data refreshed');
                })
                .catch(error => {
                    console.error('Error loading dashboard data:', error);
                    showError('Failed to refresh dashboard data');
                })
                .finally(() => {
                    isRefreshing = false;
                    if (refreshBtn) {
                        refreshBtn.disabled = false;
                        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                    }
                });
        }

        // Update Dashboard Data
        function updateDashboardData(data) {
            // Update user count if available (handle both camelCase and snake_case)
            const userCountElement = document.getElementById('userCount');
            const activeUsersCount = data.activeUsersCount || data.active_users_count || 
                                   data.overview?.activeUsersCount || data.overview?.active_users_count;
            
            if (userCountElement && activeUsersCount !== undefined) {
                userCountElement.textContent = activeUsersCount;
                console.log('Updated user count to:', activeUsersCount);
            }
        }

        // Update System Status
        function updateSystemStatus() {
            fetch('/admin/api/system-health')
                .then(response => response.json())
                .then(data => {
                    updateStatusIndicators(data);
                })
                .catch(error => {
                    console.error('Error fetching system status:', error);
                    // Set all indicators to warning state
                    setAllIndicatorsToWarning();
                });
        }

        // Update Status Indicators
        function updateStatusIndicators(healthData) {
            console.log('Health data received:', healthData);
            
            // Adapt to AdminDashboardService.SystemHealth structure (snake_case fields)
            const indicators = {
                'apiStatus': true, // API is working if we got response
                'redisStatus': healthData.redis_healthy !== false,
                'botStatus': healthData.bot_healthy !== false,
                'cacheStatus': healthData.cache_healthy !== false
            };

            Object.keys(indicators).forEach(indicatorId => {
                const indicator = document.getElementById(indicatorId);
                if (indicator) {
                    const isHealthy = indicators[indicatorId];
                    indicator.className = `status-indicator rounded-circle mx-auto mb-2 ${isHealthy ? 'bg-success' : 'bg-danger'}`;
                }
            });

            // Update health score directly from data
            updateHealthScore(healthData);
        }

        // Get Status Class
        function getStatusClass(isHealthy) {
            return isHealthy ? 'bg-success' : 'bg-danger';
        }

        // Update Health Score
        function updateHealthScore(healthData) {
            const healthScore = healthData.health_score || 0; // snake_case field
            const healthScoreBar = document.getElementById('healthScoreBar');
            const healthScoreText = document.getElementById('healthScoreText');

            console.log('Updating health score:', healthScore);

            if (healthScoreBar && healthScoreText) {
                healthScoreBar.style.width = healthScore + '%';
                healthScoreBar.className = `progress-bar ${getHealthScoreClass(healthScore)}`;
                healthScoreText.textContent = healthScore + '%';
            }
        }

        // Calculate Health Score - not needed, comes from backend
        function calculateHealthScore(healthData) {
            return healthData.healthScore || 0;
        }

        // Get Health Score Class
        function getHealthScoreClass(score) {
            if (score >= 80) return 'bg-success';
            if (score >= 60) return 'bg-warning';
            return 'bg-danger';
        }

        // Set All Indicators to Warning
        function setAllIndicatorsToWarning() {
            ['apiStatus', 'redisStatus', 'botStatus', 'cacheStatus'].forEach(id => {
                const indicator = document.getElementById(id);
                if (indicator) {
                    indicator.className = 'status-indicator bg-warning rounded-circle mx-auto mb-2';
                }
            });
        }

        // Toggle Flag
        function toggleFlag(flagName) {
            if (!flagName) return;

            fetch(`/admin/api/feature-flags/${flagName}/toggle`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => {
                if (response.ok) {
                    showSuccess(`Flag "${flagName}" toggled successfully`);
                    // Refresh page after delay to show updated status
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    throw new Error('Failed to toggle flag');
                }
            })
            .catch(error => {
                console.error('Error toggling flag:', error);
                showError(`Failed to toggle flag "${flagName}"`);
            });
        }

        // Refresh Functions
        function refreshData() {
            loadDashboardData();
            updateSystemStatus();
        }

        function refreshCache() {
            // Use the secured fetch with CSRF protection
            window.AdminGlobals.securedFetch('/admin/api/refresh-cache', { 
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess(data.message || 'Cache refreshed successfully');
                    loadDashboardData();
                } else {
                    throw new Error(data.message || 'Failed to refresh cache');
                }
            })
            .catch(error => {
                console.error('Error refreshing cache:', error);
                showError('Failed to refresh cache: ' + error.message);
            });
        }

        function exportConfig() {
            window.open('/admin/api/export-config', '_blank');
        }

        // Auto Refresh
        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                updateSystemStatus();
            }, 30000); // Refresh every 30 seconds
        }

        // Filter Activities Function
        function filterActivities(filterId) {
            const activityRows = document.querySelectorAll('.activity-row');
            const emptyState = document.getElementById('emptyState');
            let visibleCount = 0;

            activityRows.forEach(row => {
                const activityType = row.getAttribute('data-type');
                let shouldShow = false;

                switch (filterId) {
                    case 'filterAll':
                        shouldShow = true;
                        break;
                    case 'filterOrders':
                        shouldShow = activityType === 'ORDER';
                        break;
                    case 'filterFlags':
                        shouldShow = activityType === 'FEATURE_FLAG';
                        break;
                }

                if (shouldShow) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Show/hide empty state based on visible rows
            if (emptyState) {
                if (visibleCount === 0 && activityRows.length > 0) {
                    emptyState.style.display = '';
                    // Update empty state message based on filter
                    const emptyMessage = emptyState.querySelector('p');
                    if (emptyMessage) {
                        switch (filterId) {
                            case 'filterOrders':
                                emptyMessage.textContent = 'No recent orders found';
                                break;
                            case 'filterFlags':
                                emptyMessage.textContent = 'No recent feature flag updates found';
                                break;
                            default:
                                emptyMessage.textContent = 'No recent activity found';
                        }
                    }
                } else {
                    emptyState.style.display = 'none';
                }
            }

            console.log(`Filter applied: ${filterId}, Visible rows: ${visibleCount}`);
        }

        // Utility Functions - use centralized toast system
        function showSuccess(message) {
            showToast(message, 'success');
        }

        function showError(message) {
            showToast(message, 'danger');
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>
