<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{admin/layout :: head}">
    <title>Dashboard - Admin Panel</title>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <a href="/admin" class="sidebar-brand">
            <i class="fas fa-flag"></i>
            <strong>Feature Flags</strong>
        </a>
        
        <ul class="sidebar-nav">
            <li>
                <a href="/admin" class="nav-link active">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </a>
            </li>
            <li>
                <a href="/admin/feature-flags" class="nav-link">
                    <i class="fas fa-toggle-on"></i>
                    Feature Flags
                </a>
            </li>
            <li>
                <a href="/admin/monitoring" class="nav-link">
                    <i class="fas fa-chart-line"></i>
                    Monitoring
                </a>
            </li>
        </ul>
    </nav>
    
    <!-- Main Content -->
    <main class="main-content">
        <!-- Mobile Menu Button -->
        <button class="btn btn-primary d-md-none mb-3" id="sidebarToggle" title="Toggle menu">
            <i class="fas fa-bars"></i>
        </button>
        
        <!-- Page Header -->
        <div class="header-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">Dashboard</h1>
                    <p class="text-muted mb-0">Feature Flags Overview</p>
                </div>
                <div>
                    <button class="btn btn-outline-primary me-2" onclick="refreshData()" title="Refresh data">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                    <span class="badge bg-success">
                        <i class="fas fa-circle"></i>
                        Online
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="stats-icon text-primary">
                        <i class="fas fa-flag"></i>
                    </div>
                    <h3 class="h4 mb-1" th:text="${totalFlags ?: 0}">0</h3>
                    <p class="text-muted mb-0">Total Flags</p>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="stats-icon text-success">
                        <i class="fas fa-toggle-on"></i>
                    </div>
                    <h3 class="h4 mb-1" th:text="${activeFlagsCount ?: 0}">0</h3>
                    <p class="text-muted mb-0">Active Flags</p>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="stats-icon text-info">
                        <i class="fas fa-memory"></i>
                    </div>
                    <h3 class="h4 mb-1" th:text="${cacheSize ?: 0}">0</h3>
                    <p class="text-muted mb-0">Cache Size</p>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="stats-icon text-warning">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3 class="h4 mb-1" id="userCount" th:text="${activeUsersCount ?: 0}">0</h3>
                    <p class="text-muted mb-0">Active Users</p>
                </div>
            </div>
        </div>
        
        <!-- Recent Activity -->
        <div class="row">
            <div class="col-lg-8 mb-4">
                <div class="recent-flags-table">
                    <div class="p-3 border-bottom">
                        <h5 class="mb-0">
                            <i class="fas fa-history text-primary me-2"></i>
                            Recent Feature Flags
                        </h5>
                    </div>
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Flag Name</th>
                                <th>Status</th>
                                <th>Rollout %</th>
                                <th>Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="flag : ${flags}" th:if="${flagStat.count <= 5}" class="flag-row">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-flag me-2 text-muted"></i>
                                        <div>
                                            <div class="flag-name" th:text="${flag.name}">FLAG_NAME</div>
                                            <small class="text-muted" style="color: white !important" th:text="${flag.description}">Description</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span th:class="${flag.enabled} ? 'status-badge status-active' : 'status-badge status-inactive'"
                                          th:text="${flag.enabled} ? 'Active' : 'Inactive'">
                                        Status
                                    </span>
                                </td>
                                <td>
                                    <span th:text="${flag.rolloutPercentage != null ? flag.rolloutPercentage + '%' : '100%'}">100%</span>
                                </td>
                                <td>
                                    <small th:text="${#temporals.format(flag.updatedAt ?: flag.createdAt, 'dd.MM.yyyy HH:mm')}">
                                        01.01.2024 12:00
                                    </small>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary me-1 toggle-flag-btn" 
                                            th:data-flag-name="${flag.name}" title="Toggle flag">
                                        <i class="fas fa-toggle-on"></i>
                                    </button>
                                    <a th:href="@{/admin/feature-flags/{name}/edit(name=${flag.name})}" 
                                       class="btn btn-sm btn-outline-secondary" title="Edit flag">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </td>
                            </tr>
                            
                            <!-- Empty state -->
                            <tr th:if="${#lists.isEmpty(flags)}">
                                <td colspan="5" class="text-center py-4">
                                    <i class="fas fa-flag fa-2x text-muted mb-3"></i>
                                    <p class="text-muted mb-3">No feature flags found</p>
                                    <a href="/admin/feature-flags/new" class="btn btn-primary">
                                        <i class="fas fa-plus me-2"></i>
                                        Create First Flag
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="p-3 border-top bg-light" th:if="${flags != null and #lists.size(flags) > 5}">
                        <a href="/admin/feature-flags" class="btn btn-sm btn-outline-primary">
                            View All Flags
                            <i class="fas fa-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4 mb-4">
                <!-- Quick Actions -->
                <div class="feature-flag-card">
                    <h5 class="mb-3">
                        <i class="fas fa-bolt text-warning me-2"></i>
                        Quick Actions
                    </h5>
                    
                    <div class="d-grid gap-2">
                        <a href="/admin/feature-flags/new" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>
                            Create New Flag
                        </a>
                        
                        <button class="btn btn-outline-secondary" onclick="refreshCache()">
                            <i class="fas fa-sync-alt me-2"></i>
                            Refresh Cache
                        </button>
                        
                        <a href="/admin/monitoring" class="btn btn-outline-info">
                            <i class="fas fa-chart-line me-2"></i>
                            View Monitoring
                        </a>
                        
                        <button class="btn btn-outline-warning" onclick="exportConfig()">
                            <i class="fas fa-download me-2"></i>
                            Export Config
                        </button>
                    </div>
                </div>
                
                <!-- System Status -->
                <div class="feature-flag-card mt-4">
                    <h5 class="mb-3">
                        <i class="fas fa-server text-info me-2"></i>
                        System Status
                    </h5>
                    
                    <div class="row text-center" id="systemStatusIndicators">
                        <div class="col-6 mb-3">
                            <div class="status-indicator bg-secondary rounded-circle mx-auto mb-2" 
                                 style="width: 20px; height: 20px;" id="apiStatus"></div>
                            <small class="text-muted d-block">API</small>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="status-indicator bg-secondary rounded-circle mx-auto mb-2" 
                                 style="width: 20px; height: 20px;" id="redisStatus"></div>
                            <small class="text-muted d-block">Redis</small>
                        </div>
                        <div class="col-6">
                            <div class="status-indicator bg-secondary rounded-circle mx-auto mb-2" 
                                 style="width: 20px; height: 20px;" id="botStatus"></div>
                            <small class="text-muted d-block">Bot</small>
                        </div>
                        <div class="col-6">
                            <div class="status-indicator bg-secondary rounded-circle mx-auto mb-2" 
                                 style="width: 20px; height: 20px;" id="cacheStatus"></div>
                            <small class="text-muted d-block">Cache</small>
                        </div>
                    </div>
                    
                    <!-- Health Score -->
                    <div class="mt-3 text-center">
                        <small class="text-muted">Health Score:</small>
                        <div class="progress mt-1" style="height: 8px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: 0%" id="healthScoreBar"></div>
                        </div>
                        <small class="text-muted" id="healthScoreText">Loading...</small>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast notifications container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="successToast" class="toast" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    <span id="successMessage">Action completed successfully!</span>
                </div>
                <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
        
        <div id="errorToast" class="toast" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-exclamation-circle text-danger me-2"></i>
                    <span id="errorMessage">An error occurred!</span>
                </div>
                <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script th:replace="~{admin/layout :: scripts}"></script>
    <script>
        // Dashboard Variables
        let refreshInterval;
        let isRefreshing = false;

        // DOM Ready
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            updateSystemStatus();
            startAutoRefresh();
            setupEventListeners();
        });

        // Initialize Dashboard
        function initializeDashboard() {
            console.log('Dashboard initialized');
            loadDashboardData();
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Toggle Flag Buttons
            document.querySelectorAll('.toggle-flag-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const flagName = this.getAttribute('data-flag-name');
                    toggleFlag(flagName);
                });
            });

            // Sidebar Toggle for Mobile
            const sidebarToggle = document.getElementById('sidebarToggle');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    document.querySelector('.sidebar').classList.toggle('show');
                });
            }
        }

        // Load Dashboard Data
        function loadDashboardData() {
            if (isRefreshing) return;
            
            isRefreshing = true;
            const refreshBtn = document.querySelector('[onclick="refreshData()"]');
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<i class="fas fa-spin fa-sync-alt"></i> Refreshing...';
            }

            fetch('/admin/api/dashboard-data')
                .then(response => response.json())
                .then(data => {
                    updateDashboardData(data);
                    showSuccess('Dashboard data refreshed');
                })
                .catch(error => {
                    console.error('Error loading dashboard data:', error);
                    showError('Failed to refresh dashboard data');
                })
                .finally(() => {
                    isRefreshing = false;
                    if (refreshBtn) {
                        refreshBtn.disabled = false;
                        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                    }
                });
        }

        // Update Dashboard Data
        function updateDashboardData(data) {
            // Update user count if available
            const userCountElement = document.getElementById('userCount');
            if (userCountElement && data.activeUsersCount !== undefined) {
                userCountElement.textContent = data.activeUsersCount;
            }
        }

        // Update System Status
        function updateSystemStatus() {
            fetch('/admin/api/system-health')
                .then(response => response.json())
                .then(data => {
                    updateStatusIndicators(data);
                })
                .catch(error => {
                    console.error('Error fetching system status:', error);
                    // Set all indicators to warning state
                    setAllIndicatorsToWarning();
                });
        }

        // Update Status Indicators
        function updateStatusIndicators(healthData) {
            const indicators = {
                'apiStatus': healthData.components?.api?.status || 'DOWN',
                'redisStatus': healthData.components?.redis?.status || 'DOWN',
                'botStatus': healthData.components?.telegram?.status || 'DOWN',
                'cacheStatus': healthData.components?.cache?.status || 'DOWN'
            };

            Object.keys(indicators).forEach(indicatorId => {
                const indicator = document.getElementById(indicatorId);
                if (indicator) {
                    const status = indicators[indicatorId];
                    indicator.className = `status-indicator rounded-circle mx-auto mb-2 ${getStatusClass(status)}`;
                }
            });

            // Update health score
            updateHealthScore(healthData);
        }

        // Get Status Class
        function getStatusClass(status) {
            switch (status.toUpperCase()) {
                case 'UP': return 'bg-success';
                case 'DOWN': return 'bg-danger';
                case 'WARNING': return 'bg-warning';
                default: return 'bg-secondary';
            }
        }

        // Update Health Score
        function updateHealthScore(healthData) {
            const healthScore = calculateHealthScore(healthData);
            const healthScoreBar = document.getElementById('healthScoreBar');
            const healthScoreText = document.getElementById('healthScoreText');

            if (healthScoreBar && healthScoreText) {
                healthScoreBar.style.width = healthScore + '%';
                healthScoreBar.className = `progress-bar ${getHealthScoreClass(healthScore)}`;
                healthScoreText.textContent = healthScore + '%';
            }
        }

        // Calculate Health Score
        function calculateHealthScore(healthData) {
            if (!healthData.components) return 0;
            
            const components = Object.values(healthData.components);
            const upComponents = components.filter(c => c.status === 'UP').length;
            return Math.round((upComponents / components.length) * 100);
        }

        // Get Health Score Class
        function getHealthScoreClass(score) {
            if (score >= 80) return 'bg-success';
            if (score >= 60) return 'bg-warning';
            return 'bg-danger';
        }

        // Set All Indicators to Warning
        function setAllIndicatorsToWarning() {
            ['apiStatus', 'redisStatus', 'botStatus', 'cacheStatus'].forEach(id => {
                const indicator = document.getElementById(id);
                if (indicator) {
                    indicator.className = 'status-indicator bg-warning rounded-circle mx-auto mb-2';
                }
            });
        }

        // Toggle Flag
        function toggleFlag(flagName) {
            if (!flagName) return;

            fetch(`/admin/api/feature-flags/${flagName}/toggle`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => {
                if (response.ok) {
                    showSuccess(`Flag "${flagName}" toggled successfully`);
                    // Refresh page after delay to show updated status
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    throw new Error('Failed to toggle flag');
                }
            })
            .catch(error => {
                console.error('Error toggling flag:', error);
                showError(`Failed to toggle flag "${flagName}"`);
            });
        }

        // Refresh Functions
        function refreshData() {
            loadDashboardData();
            updateSystemStatus();
        }

        function refreshCache() {
            fetch('/admin/api/refresh-cache', { method: 'POST' })
                .then(response => {
                    if (response.ok) {
                        showSuccess('Cache refreshed successfully');
                        loadDashboardData();
                    } else {
                        throw new Error('Failed to refresh cache');
                    }
                })
                .catch(error => {
                    console.error('Error refreshing cache:', error);
                    showError('Failed to refresh cache');
                });
        }

        function exportConfig() {
            window.open('/admin/api/export-config', '_blank');
        }

        // Auto Refresh
        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                updateSystemStatus();
            }, 30000); // Refresh every 30 seconds
        }

        // Utility Functions
        function showSuccess(message) {
            const successToast = document.getElementById('successToast');
            const successMessage = document.getElementById('successMessage');
            if (successToast && successMessage) {
                successMessage.textContent = message;
                const toast = new bootstrap.Toast(successToast);
                toast.show();
            }
        }

        function showError(message) {
            const errorToast = document.getElementById('errorToast');
            const errorMessage = document.getElementById('errorMessage');
            if (errorToast && errorMessage) {
                errorMessage.textContent = message;
                const toast = new bootstrap.Toast(errorToast);
                toast.show();
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>
