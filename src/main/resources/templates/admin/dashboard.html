<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{admin/layout :: head}">
    <title>Dashboard - Admin Panel</title>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <a href="/admin" class="sidebar-brand">
            <i class="fas fa-flag"></i>
            <strong>Feature Flags</strong>
        </a>
        
        <ul class="sidebar-nav">
            <li>
                <a href="/admin" class="nav-link active">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </a>
            </li>
            <li>
                <a href="/admin/feature-flags" class="nav-link">
                    <i class="fas fa-toggle-on"></i>
                    Feature Flags
                </a>
            </li>
            <li>
                <a href="/admin/monitoring" class="nav-link">
                    <i class="fas fa-chart-line"></i>
                    Monitoring
                </a>
            </li>
        </ul>
    </nav>
    
    <!-- Main Content -->
    <main class="main-content">
        <!-- Mobile Menu Button -->
        <button class="btn btn-primary d-md-none mb-3" id="sidebarToggle" title="Toggle menu">
            <i class="fas fa-bars"></i>
        </button>
        
        <!-- Page Header -->
        <div class="header-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">Dashboard</h1>
                    <p class="text-muted mb-0">Feature Flags Overview</p>
                </div>
                <div>
                    <button class="btn btn-outline-primary me-2" onclick="refreshData()" title="Refresh data">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                    <span class="badge bg-success">
                        <i class="fas fa-circle"></i>
                        Online
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="stats-icon text-primary">
                        <i class="fas fa-flag"></i>
                    </div>
                    <h3 class="h4 mb-1" th:text="${totalFlags ?: 0}">0</h3>
                    <p class="text-muted mb-0">Total Flags</p>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="stats-icon text-success">
                        <i class="fas fa-toggle-on"></i>
                    </div>
                    <h3 class="h4 mb-1" th:text="${activeFlagsCount ?: 0}">0</h3>
                    <p class="text-muted mb-0">Active Flags</p>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="stats-icon text-info">
                        <i class="fas fa-memory"></i>
                    </div>
                    <h3 class="h4 mb-1" th:text="${cacheSize ?: 0}">0</h3>
                    <p class="text-muted mb-0">Cache Size</p>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="stats-icon text-warning">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3 class="h4 mb-1" id="userCount" th:text="${activeUsersCount ?: 0}">0</h3>
                    <p class="text-muted mb-0">Active Users</p>
                </div>
            </div>
        </div>
        
        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-lg-8 mb-4">
                <div class="chart-container">
                    <h5 class="mb-3">
                        <i class="fas fa-chart-line text-primary me-2"></i>
                        Feature Flags Usage
                    </h5>
                    <canvas id="flagsUsageChart" width="400" height="200"></canvas>
                </div>
            </div>
            
            <div class="col-lg-4 mb-4">
                <div class="chart-container">
                    <h5 class="mb-3">
                        <i class="fas fa-chart-pie text-success me-2"></i>
                        Flags Status
                    </h5>
                    <canvas id="flagsStatusChart" width="300" height="300"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Recent Activity -->
        <div class="row">
            <div class="col-lg-8 mb-4">
                <div class="table-responsive">
                    <div class="p-3 border-bottom">
                        <h5 class="mb-0">
                            <i class="fas fa-history text-primary me-2"></i>
                            Recent Feature Flags
                        </h5>
                    </div>
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Flag Name</th>
                                <th>Status</th>
                                <th>Rollout %</th>
                                <th>Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="flag : ${flags}" th:if="${flagStat.count <= 5}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-flag me-2 text-muted"></i>
                                        <div>
                                            <div class="fw-bold" th:text="${flag.name}">FLAG_NAME</div>
                                            <small class="text-muted" th:text="${flag.description}">Description</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span th:class="${flag.enabled} ? 'status-badge status-active' : 'status-badge status-inactive'"
                                          th:text="${flag.enabled} ? 'Active' : 'Inactive'">
                                        Status
                                    </span>
                                </td>
                                <td>
                                    <span th:text="${flag.rolloutPercentage != null ? flag.rolloutPercentage + '%' : '100%'}">100%</span>
                                </td>
                                <td>
                                    <small th:text="${#temporals.format(flag.updatedAt ?: flag.createdAt, 'dd.MM.yyyy HH:mm')}">
                                        01.01.2024 12:00
                                    </small>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary me-1 toggle-flag-btn" 
                                            th:data-flag-name="${flag.name}" title="Toggle flag">
                                        <i class="fas fa-toggle-on"></i>
                                    </button>
                                    <a th:href="@{/admin/feature-flags/{name}/edit(name=${flag.name})}" 
                                       class="btn btn-sm btn-outline-secondary" title="Edit flag">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </td>
                            </tr>
                            
                            <!-- Empty state -->
                            <tr th:if="${#lists.isEmpty(flags)}">
                                <td colspan="5" class="text-center py-4">
                                    <i class="fas fa-flag fa-2x text-muted mb-3"></i>
                                    <p class="text-muted mb-3">No feature flags found</p>
                                    <a href="/admin/feature-flags/new" class="btn btn-primary">
                                        <i class="fas fa-plus me-2"></i>
                                        Create First Flag
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="p-3 border-top bg-light" th:if="${flags != null and #lists.size(flags) > 5}">
                        <a href="/admin/feature-flags" class="btn btn-sm btn-outline-primary">
                            View All Flags
                            <i class="fas fa-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4 mb-4">
                <!-- Quick Actions -->
                <div class="feature-flag-card">
                    <h5 class="mb-3">
                        <i class="fas fa-bolt text-warning me-2"></i>
                        Quick Actions
                    </h5>
                    
                    <div class="d-grid gap-2">
                        <a href="/admin/feature-flags/new" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>
                            Create New Flag
                        </a>
                        
                        <button class="btn btn-outline-secondary" onclick="refreshCache()">
                            <i class="fas fa-sync-alt me-2"></i>
                            Refresh Cache
                        </button>
                        
                        <a href="/admin/monitoring" class="btn btn-outline-info">
                            <i class="fas fa-chart-line me-2"></i>
                            View Monitoring
                        </a>
                        
                        <button class="btn btn-outline-warning" onclick="exportConfig()">
                            <i class="fas fa-download me-2"></i>
                            Export Config
                        </button>
                    </div>
                </div>
                
                <!-- System Status -->
                <div class="feature-flag-card mt-4">
                    <h5 class="mb-3">
                        <i class="fas fa-server text-info me-2"></i>
                        System Status
                    </h5>
                    
                    <div class="row text-center" id="systemStatusIndicators">
                        <div class="col-6 mb-3">
                            <div class="status-indicator bg-secondary rounded-circle mx-auto mb-2" 
                                 style="width: 20px; height: 20px;" id="apiStatus"></div>
                            <small class="text-muted d-block">API</small>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="status-indicator bg-secondary rounded-circle mx-auto mb-2" 
                                 style="width: 20px; height: 20px;" id="redisStatus"></div>
                            <small class="text-muted d-block">Redis</small>
                        </div>
                        <div class="col-6">
                            <div class="status-indicator bg-secondary rounded-circle mx-auto mb-2" 
                                 style="width: 20px; height: 20px;" id="botStatus"></div>
                            <small class="text-muted d-block">Bot</small>
                        </div>
                        <div class="col-6">
                            <div class="status-indicator bg-secondary rounded-circle mx-auto mb-2" 
                                 style="width: 20px; height: 20px;" id="cacheStatus"></div>
                            <small class="text-muted d-block">Cache</small>
                        </div>
                    </div>
                    
                    <!-- Health Score -->
                    <div class="mt-3 text-center">
                        <small class="text-muted">Health Score:</small>
                        <div class="progress mt-1" style="height: 8px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: 0%" id="healthScoreBar"></div>
                        </div>
                        <small class="text-muted" id="healthScoreText">Loading...</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Loading Spinner -->
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading dashboard data...</p>
        </div>
    </main>
    
    <!-- Toast Container -->
    <div class="toast-container"></div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Dashboard specific variables
        let dashboardFlagsUsageChart, dashboardFlagsStatusChart;
        
        // Initialize AdminGlobals if not exists
        window.AdminGlobals = window.AdminGlobals || {};
        
        // Mobile sidebar toggle (only if not already set)
        if (!window.AdminGlobals.sidebarToggleSet) {
            const sidebarToggle = document.getElementById('sidebarToggle');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    const sidebar = document.querySelector('.sidebar');
                    if (sidebar) sidebar.classList.toggle('show');
                });
            }
            window.AdminGlobals.sidebarToggleSet = true;
        }
        
        // Override global refresh function
        function refreshData() {
            showLoading();
            
            fetch('/admin/api/dashboard-data')
                .then(response => response.json())
                .then(data => {
                    updateStats(data);
                    updateCharts(data);
                    updateSystemStatus();
                    hideLoading();
                    showToast('Dashboard data refreshed', 'success');
                })
                .catch(error => {
                    console.error('Error refreshing data:', error);
                    hideLoading();
                    showToast('Error refreshing data', 'danger');
                });
        }
        
        function updateSystemStatus() {
            fetch('/admin/api/system-health')
                .then(response => response.json())
                .then(healthData => {
                    // Update status indicators
                    updateStatusIndicator('apiStatus', true); // API is working if we get response
                    updateStatusIndicator('redisStatus', healthData.redisHealthy !== false);
                    updateStatusIndicator('botStatus', healthData.botHealthy !== false);
                    updateStatusIndicator('cacheStatus', healthData.cacheHealthy !== false);
                    
                    // Update health score
                    const healthScore = healthData.healthScore || 0;
                    const healthScoreBar = document.getElementById('healthScoreBar');
                    const healthScoreText = document.getElementById('healthScoreText');
                    
                    if (healthScoreBar) {
                        healthScoreBar.style.width = healthScore + '%';
                        // Change color based on health score
                        healthScoreBar.className = 'progress-bar ' + 
                            (healthScore >= 80 ? 'bg-success' : 
                             healthScore >= 60 ? 'bg-warning' : 'bg-danger');
                    }
                    
                    if (healthScoreText) {
                        healthScoreText.textContent = healthScore + '%';
                    }
                })
                .catch(error => {
                    console.warn('Could not fetch system health:', error);
                    // Set all indicators to warning state
                    updateStatusIndicator('apiStatus', false);
                    updateStatusIndicator('redisStatus', false);
                    updateStatusIndicator('botStatus', false);
                    updateStatusIndicator('cacheStatus', false);
                    
                    const healthScoreText = document.getElementById('healthScoreText');
                    if (healthScoreText) {
                        healthScoreText.textContent = 'Error';
                    }
                });
        }
        
        function updateStatusIndicator(elementId, isHealthy) {
            const indicator = document.getElementById(elementId);
            if (indicator) {
                indicator.className = indicator.className.replace(/bg-\w+/, '');
                indicator.classList.add(isHealthy ? 'bg-success' : 'bg-danger');
            }
        }
        
        function updateStats(data) {
            // Only update stats if data exists and is valid, otherwise keep current values
            const statsCards = document.querySelectorAll('.stats-card h3');
            
            // Update Total Flags only if we have valid data
            if (statsCards[0] && data && typeof data.totalFlags === 'number') {
                statsCards[0].textContent = data.totalFlags;
            }
            
            // Update Active Flags only if we have valid data
            if (statsCards[1] && data && typeof data.activeFlags === 'number') {
                statsCards[1].textContent = data.activeFlags;
            }
            
            // Update Cache Size only if we have valid data
            if (statsCards[2] && data && typeof data.cacheSize === 'number') {
                statsCards[2].textContent = data.cacheSize;
            }
            
            // Update user count from API independently
            updateUserCount(data);
        }
        
        function updateUserCount(data) {
            const userCountEl = document.getElementById('userCount');
            if (!userCountEl) return;
            
            // Try multiple data sources in priority order
            let userCount = null;
            
            // 1. Direct dashboard overview fields (highest priority)
            if (data && data.overview) {
                if (typeof data.overview.activeUsersCount === 'number') {
                    userCount = data.overview.activeUsersCount;
                } else if (typeof data.overview.onlineUsersCount === 'number') {
                    userCount = data.overview.onlineUsersCount;
                } else if (data.overview.userStatistics && typeof data.overview.userStatistics.activeUsersCount === 'number') {
                    userCount = data.overview.userStatistics.activeUsersCount;
                }
            }
            
            // 2. Dashboard data direct fields
            if (userCount === null && data) {
                if (typeof data.activeUsersCount === 'number') {
                    userCount = data.activeUsersCount;
                } else if (typeof data.onlineUsersCount === 'number') {
                    userCount = data.onlineUsersCount;
                }
            }
            
            // Update if we found a valid count
            if (userCount !== null) {
                userCountEl.textContent = userCount;
                console.log('Updated user count to:', userCount);
                return;
            }
            
            // 3. Fallback to system health API for user count
            fetch('/admin/api/system-health')
                .then(response => response.json())
                .then(healthData => {
                    if (healthData && typeof healthData.activeUsersCount === 'number') {
                        userCountEl.textContent = healthData.activeUsersCount;
                        console.log('Updated user count from health API:', healthData.activeUsersCount);
                    } else if (healthData && typeof healthData.onlineUsersCount === 'number') {
                        userCountEl.textContent = healthData.onlineUsersCount;
                        console.log('Updated user count from health API (online):', healthData.onlineUsersCount);
                    } else {
                        console.warn('No valid user count found in health data:', healthData);
                    }
                })
                .catch(error => {
                    console.warn('Could not fetch user count:', error);
                    // Don't change the current value on error
                });
        }
        
        function updateCharts(data) {
            // Update usage chart with real analytics data
            if (dashboardFlagsUsageChart) {
                // Fetch real analytics data for last 7 time periods
                fetch('/admin/api/analytics/7')
                    .then(response => response.json())
                    .then(analyticsData => {
                        if (analyticsData && analyticsData.dailyActiveUsers) {
                            // Use real daily active users data
                            const realData = analyticsData.dailyActiveUsers.map(day => day.activeUsers || 0);
                            dashboardFlagsUsageChart.data.datasets[0].data = realData;
                        } else {
                            // Fallback to generated data if no real data available
                            dashboardFlagsUsageChart.data.datasets[0].data = generateUsageData();
                        }
                        dashboardFlagsUsageChart.update();
                    })
                    .catch(error => {
                        console.warn('Could not fetch analytics data:', error);
                        dashboardFlagsUsageChart.data.datasets[0].data = generateUsageData();
                        dashboardFlagsUsageChart.update();
                    });
            }
            
            // Update status chart
            if (dashboardFlagsStatusChart) {
                dashboardFlagsStatusChart.data.datasets[0].data = [data.activeFlags, data.totalFlags - data.activeFlags];
                dashboardFlagsStatusChart.update();
            }
        }
        
        function initCharts() {
            // Check if chart elements exist
            const usageCtx = document.getElementById('flagsUsageChart');
            const statusCtx = document.getElementById('flagsStatusChart');
            
            if (!usageCtx || !statusCtx) {
                console.warn('Chart elements not found');
                return;
            }
            
            // Flags Usage Chart
            dashboardFlagsUsageChart = new Chart(usageCtx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: ['6h ago', '5h ago', '4h ago', '3h ago', '2h ago', '1h ago', 'Now'],
                    datasets: [{
                        label: 'Flag Checks',
                        data: generateUsageData(),
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
            
            // Flags Status Chart
            const activeFlagsElement = document.querySelector('[th\\:text*="activeFlagsCount"]');
            const totalFlagsElement = document.querySelector('[th\\:text*="totalFlags"]');
            const activeFlags = activeFlagsElement ? parseInt(activeFlagsElement.textContent) || 0 : 0;
            const totalFlags = totalFlagsElement ? parseInt(totalFlagsElement.textContent) || 0 : 0;
            
            dashboardFlagsStatusChart = new Chart(statusCtx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Active', 'Inactive'],
                    datasets: [{
                        data: [activeFlags, totalFlags - activeFlags],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        function generateUsageData() {
            return Array.from({length: 7}, () => Math.floor(Math.random() * 100) + 20);
        }
        
        function toggleFlag(flagName) {
            // Use improved CSRF handling from layout
            if (!window.AdminGlobals || !window.AdminGlobals.csrf) {
                console.error('CSRF protection not available - retrying in 1 second...');
                setTimeout(() => toggleFlag(flagName), 1000);
                return;
            }
            
            window.AdminGlobals.securedFetch(`/admin/feature-flags/${flagName}/toggle`, {
                method: 'POST'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.text();
            })
            .then(result => {
                if (result === 'enabled' || result === 'disabled') {
                    showToast(`Flag ${flagName} ${result}`, 'success');
                    
                    // Immediately update the UI for the toggled flag
                    updateFlagStatusInUI(flagName, result);
                    
                    // Also refresh data after a short delay to get updated counts
                    setTimeout(refreshData, 500);
                } else {
                    console.error('Unexpected response:', result);
                    showToast(`Error toggling flag ${flagName}: ${result}`, 'danger');
                }
            })
            .catch(error => {
                console.error('Error toggling flag:', error);
                showToast(`Error toggling flag ${flagName}: ${error.message}`, 'danger');
            });
        }
        
        function updateFlagStatusInUI(flagName, status) {
            // Find the flag row and update its status badge
            const flagRows = document.querySelectorAll('tbody tr');
            flagRows.forEach(row => {
                const toggleBtn = row.querySelector(`[data-flag-name="${flagName}"]`);
                if (toggleBtn) {
                    const statusBadge = row.querySelector('.status-badge');
                    if (statusBadge) {
                        if (status === 'enabled') {
                            statusBadge.className = 'status-badge status-active';
                            statusBadge.textContent = 'Active';
                        } else {
                            statusBadge.className = 'status-badge status-inactive';
                            statusBadge.textContent = 'Inactive';
                        }
                    }
                }
            });
        }
        
        function refreshCache() {
            fetch('/admin/refresh-cache', {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    showToast('Cache refreshed successfully', 'success');
                    setTimeout(refreshData, 1000);
                } else {
                    showToast('Error refreshing cache', 'danger');
                }
            })
            .catch(error => {
                console.error('Error refreshing cache:', error);
                showToast('Error refreshing cache', 'danger');
            });
        }
        
        function exportConfig() {
            showToast('Config export feature coming soon', 'info');
        }
        
        // Toast notification
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) return;
            
            const toastId = 'toast-' + Date.now();
            
            const toastHtml = `
                <div class="toast" id="${toastId}" role="alert">
                    <div class="toast-header">
                        <i class="fas fa-${getToastIcon(type)} text-${type} me-2"></i>
                        <strong class="me-auto">Admin Panel</strong>
                        <small class="text-muted">just now</small>
                        <button type="button" class="btn-close" data-bs-dismiss="toast" title="Close"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toast = new bootstrap.Toast(document.getElementById(toastId));
            toast.show();
            
            // Remove toast element after it's hidden
            document.getElementById(toastId).addEventListener('hidden.bs.toast', function() {
                this.remove();
            });
        }
        
        function getToastIcon(type) {
            switch(type) {
                case 'success': return 'check-circle';
                case 'warning': return 'exclamation-triangle';
                case 'danger': return 'exclamation-circle';
                default: return 'info-circle';
            }
        }
        
        // Loading state
        function showLoading() {
            document.querySelectorAll('.loading-spinner').forEach(el => {
                el.style.display = 'block';
            });
        }
        
        function hideLoading() {
            document.querySelectorAll('.loading-spinner').forEach(el => {
                el.style.display = 'none';
            });
        }
        
        // Event delegation for toggle flag buttons
        document.addEventListener('click', function(e) {
            if (e.target.closest('.toggle-flag-btn')) {
                e.preventDefault();
                const button = e.target.closest('.toggle-flag-btn');
                const flagName = button.dataset.flagName;
                if (flagName) {
                    toggleFlag(flagName);
                }
            }
        });
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            try {
                initCharts();
                updateSystemStatus(); // Only update system status, don't refresh all data immediately
            } catch (error) {
                console.error('Dashboard initialization error:', error);
            }
        });
    </script>
</body>
</html>
