<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org" th:replace="~{admin/layout :: layout(~{::content}, ~{::scripts})}">
<head>
    <title>System Monitoring - Telegram Star Manager</title>
    <style>
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
        }
        
        .chart-container:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .feature-flag-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
        }
        
        .feature-flag-card:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .table-responsive {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        
        .loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            text-align: center;
        }
    </style>
</head>
<body>
<div th:fragment="content">
    
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="/admin" class="text-decoration-none">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                <i class="fas fa-chart-line"></i> –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã
            </li>
        </ol>
    </nav>
    
    <!-- System Status Overview -->
            <div class="row mb-4">
                <div class="col-lg-12">
                    <div class="feature-flag-card">
                        <h5 class="mb-4">
                            <i class="fas fa-server text-primary me-2"></i>
                            –û–±–∑–æ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã
                        </h5>
                        
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <div class="text-center">
                                    <div id="application-status-indicator" class="status-indicator bg-success rounded-circle mx-auto mb-2"
                                         style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-check text-white"></i>
                                    </div>
                                    <h6 class="mb-1">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h6>
                                    <small id="application-status" class="text-success">–í —Å–µ—Ç–∏</small>
                                </div>
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <div class="text-center">
                                    <div id="redis-status" class="status-indicator bg-warning rounded-circle mx-auto mb-2" 
                                         style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-exclamation text-white"></i>
                                    </div>
                                    <h6 class="mb-1">Redis</h6>
                                    <small id="redis-text" class="text-warning">Fallback Mode</small>
                                </div>
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <div class="text-center">
                                    <div id="telegram-bot-status-indicator" class="status-indicator bg-success rounded-circle mx-auto mb-2"
                                         style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-robot text-white"></i>
                                    </div>
                                    <h6 class="mb-1">Telegram Bot</h6>
                                    <small id="telegram-bot-status" class="text-success">Active</small>
                                </div>
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <div class="text-center">
                                    <div class="status-indicator bg-info rounded-circle mx-auto mb-2" 
                                         style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-clock text-white"></i>
                                    </div>
                                    <h6 class="mb-1">Uptime</h6>
                                    <small id="uptime" class="text-info">Loading...</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Performance Metrics -->
            <div class="row mb-4">
                <div class="col-lg-6 mb-4">
                    <div class="chart-container">
                        <h5 class="mb-3">
                            <i class="fas fa-tachometer-alt text-primary me-2"></i>
                            –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                        </h5>
                        
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="p-3">
                                    <h4 id="response-time" class="text-primary mb-1">--ms</h4>
                                    <small class="text-muted">Avg Response</small>
                                    <div class="small text-muted mt-1">
                                        <i class="fas fa-circle text-success" id="response-indicator" style="font-size: 6px;"></i>
                                        <span class="ms-1">Live</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="p-3">
                                    <h4 id="memory-usage" class="text-info mb-1">--%</h4>
                                    <small class="text-muted">Memory Usage</small>
                                    <div class="small text-muted mt-1">
                                        <i class="fas fa-circle text-success" id="memory-indicator" style="font-size: 6px;"></i>
                                        <span class="ms-1">Live</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="p-3">
                                    <h4 id="cache-hits" class="text-success mb-1">--%</h4>
                                    <small class="text-muted">Cache Hits</small>
                                    <div class="small text-muted mt-1">
                                        <i class="fas fa-circle text-success" id="cache-indicator" style="font-size: 6px;"></i>
                                        <span class="ms-1">Live</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
                        <div class="text-center mt-2">
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                Last updated: <span id="metrics-last-update">Loading...</span>
                            </small>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6 mb-4">
                    <div class="chart-container">
                        <h5 class="mb-3">
                            <i class="fas fa-database text-success me-2"></i>
                            Database & Cache Metrics
                        </h5>
                        
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="p-3">
                                    <h4 id="db-pool-usage" class="text-primary mb-1">--%</h4>
                                    <small class="text-muted">DB Pool Usage</small>
                                    <div class="small text-muted mt-1">
                                        <i class="fas fa-circle text-success" id="db-pool-indicator" style="font-size: 6px;"></i>
                                        <span class="ms-1">Live</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="p-3">
                                    <h4 id="cache-miss-ratio" class="text-warning mb-1">--%</h4>
                                    <small class="text-muted">Cache Miss Ratio</small>
                                    <div class="small text-muted mt-1">
                                        <i class="fas fa-circle text-success" id="cache-miss-indicator" style="font-size: 6px;"></i>
                                        <span class="ms-1">Live</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="p-3">
                                    <h4 id="active-db-connections" class="text-info mb-1">--</h4>
                                    <small class="text-muted">Active DB Connections</small>
                                    <div class="small text-muted mt-1">
                                        <i class="fas fa-circle text-success" id="db-connections-indicator" style="font-size: 6px;"></i>
                                        <span class="ms-1">Live</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="progress mt-3" style="height: 10px;">
                            <div id="health-progress" class="progress-bar bg-success" role="progressbar"
                                 style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                        <small class="text-muted">System health score: <span id="health-score-text">Loading...</span></small>
                    </div>
                </div>
            </div>
            
            <!-- System Actions -->
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="feature-flag-card">
                        <h5 class="mb-3">
                            <i class="fas fa-tools text-warning me-2"></i>
                            System Actions
                        </h5>
                        
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="checkSystemHealth()">
                                <i class="fas fa-heartbeat me-2"></i>
                                Check Health
                            </button>
                            
                            <button class="btn btn-outline-secondary" onclick="refreshCache()">
                                <i class="fas fa-sync-alt me-2"></i>
                                Refresh Cache
                            </button>
                            
                            <button class="btn btn-outline-info" onclick="clearLogs()">
                                <i class="fas fa-trash me-2"></i>
                                Clear Logs
                            </button>
                            
                            <button class="btn btn-outline-success" onclick="exportDiagnostics()">
                                <i class="fas fa-download me-2"></i>
                                Export Diagnostics
                            </button>
                            
                            <button class="btn btn-outline-warning" onclick="testDatabaseCacheMetrics()">
                                <i class="fas fa-database me-2"></i>
                                Test DB&Cache Metrics
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6 mb-4">
                    <!-- Environment Info -->
                    <div class="feature-flag-card">
                        <h5 class="mb-3">
                            <i class="fas fa-info-circle text-info me-2"></i>
                            Environment Info
                        </h5>
                        
                        <div class="small">
                            <div class="d-flex justify-content-between py-1">
                                <span class="text-muted">Platform:</span>
                                <span id="env-platform">Loading...</span>
                            </div>
                            <div class="d-flex justify-content-between py-1">
                                <span class="text-muted">Java Version:</span>
                                <span id="env-java-version">Loading...</span>
                            </div>
                            <div class="d-flex justify-content-between py-1">
                                <span class="text-muted">Spring Boot:</span>
                                <span id="env-spring-boot">Loading...</span>
                            </div>
                            <div class="d-flex justify-content-between py-1">
                                <span class="text-muted">Profile:</span>
                                <span id="env-profile" class="badge bg-primary">Loading...</span>
                            </div>
                            <div class="d-flex justify-content-between py-1">
                                <span class="text-muted">Cache Size:</span>
                                <span id="cache-size" th:text="${cacheSize ?: 0}">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Loading Spinner -->
            <div class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading monitoring data...</p>
            </div>
        </div>
    </div>
    
</div>

<!-- Page Scripts -->
<th:block th:fragment="scripts">
    <script>
        
        // Monitoring specific JavaScript
        var monitoringActivityInterval;
        var monitoringStartTime = new Date();
        
        // SSE Performance Metrics variables
        var performanceSSE = null;
        var sseConnectionStatus = 'disconnected'; // disconnected, connecting, connected, error
        var sseReconnectAttempts = 0;
        var maxSSEReconnectAttempts = 5;
        var sseReconnectTimeout = null;
        var performancePollingInterval = null;
        
        
        // ==================== SYSTEM STATUS MANAGEMENT ====================
        
        /**
         * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ Application –∏ Telegram Bot
         * @param {string} type - 'application' –∏–ª–∏ 'telegram-bot'
         * @param {boolean} isOnline - true –¥–ª—è Online/Active, false –¥–ª—è Offline/Inactive
         */
        function updateSystemStatus(type, isOnline) {
            
            const statusIndicatorId = type + '-status-indicator';
            const statusTextId = type + '-status';
            
            const indicator = document.getElementById(statusIndicatorId);
            const statusText = document.getElementById(statusTextId);
            
            if (indicator && statusText) {
                if (isOnline) {
                    // Online —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    indicator.className = indicator.className.replace(/bg-\w+/, 'bg-success');
                    if (type === 'application') {
                        indicator.innerHTML = '<i class="fas fa-check text-white"></i>';
                        statusText.textContent = 'Online';
                        statusText.className = 'text-success';
                    } else if (type === 'telegram-bot') {
                        indicator.innerHTML = '<i class="fas fa-robot text-white"></i>';
                        statusText.textContent = 'Active';
                        statusText.className = 'text-success';
                    }
                } else {
                    // Offline —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    indicator.className = indicator.className.replace(/bg-\w+/, 'bg-danger');
                    if (type === 'application') {
                        indicator.innerHTML = '<i class="fas fa-times text-white"></i>';
                        statusText.textContent = 'Offline';
                        statusText.className = 'text-danger';
                    } else if (type === 'telegram-bot') {
                        indicator.innerHTML = '<i class="fas fa-exclamation text-white"></i>';
                        statusText.textContent = 'Inactive';
                        statusText.className = 'text-danger';
                    }
                }
            } else {
                console.warn('‚ö†Ô∏è –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: System status elements not found for:', type);
            }
        }
        
        /**
         * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Environment Info –¥–∞–Ω–Ω—ã—Ö
         */
        function updateEnvironmentInfo(envData) {
            
            const platformEl = document.getElementById('env-platform');
            const javaVersionEl = document.getElementById('env-java-version');
            const springBootEl = document.getElementById('env-spring-boot');
            const profileEl = document.getElementById('env-profile');
            
            if (platformEl && envData.platform) {
                platformEl.textContent = envData.platform;
            }
            if (javaVersionEl && envData.javaVersion) {
                javaVersionEl.textContent = envData.javaVersion;
            }
            if (springBootEl && envData.springBootVersion) {
                springBootEl.textContent = envData.springBootVersion;
            }
            if (profileEl && envData.activeProfile) {
                profileEl.textContent = envData.activeProfile;
                // –û–±–Ω–æ–≤–ª—è–µ–º CSS –∫–ª–∞—Å—Å –ø—Ä–æ—Ñ–∏–ª—è
                profileEl.className = `badge bg-${getProfileBadgeColor(envData.activeProfile)}`;
            }
            
        }
        
        /**
         * –ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –±–µ–π–¥–∂–∞ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è
         */
        function getProfileBadgeColor(profile) {
            switch(profile?.toLowerCase()) {
                case 'koyeb': return 'primary';
                case 'dev': return 'warning';
                case 'prod': case 'production': return 'success';
                default: return 'secondary';
            }
        }
        
        // ==================== SSE PERFORMANCE METRICS ====================
        
        /**
         * –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ SSE endpoint
         */
        function testSSEEndpoint() {
            console.log('üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê SSE: Testing SSE endpoint accessibility...');
            
            fetch('/admin/api/metrics/test-connection')
                .then(response => {
                    console.log('üì° –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê SSE: Test endpoint response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(result => {
                    console.log('‚úÖ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê SSE: Test endpoint successful:', result);
                    if (result.success) {
                        console.log('üéØ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê SSE: SSE endpoint is accessible, proceeding with connection');
                        return true;
                    } else {
                        console.error('‚ùå –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê SSE: Test endpoint reports error:', result.error);
                        return false;
                    }
                })
                .catch(error => {
                    console.error('‚ùå –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê SSE: Test endpoint failed:', error);
                    return false;
                });
        }

        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è SSE –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è Performance Metrics
         */
        function initPerformanceSSE() {
            if (performanceSSE) {
                console.log('üîå SSE already initialized, skipping');
                return;
            }
            
            console.log('üöÄ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï SSE: Initializing SSE for Performance Metrics');
            
            // –°–Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å endpoint
            testSSEEndpoint();
            
            updateSSEConnectionStatus('connecting');
            
            try {
                performanceSSE = new EventSource('/admin/api/metrics/stream');
                
                performanceSSE.onopen = function(event) {
                    console.log('‚úÖ SSE Performance Metrics connected successfully');
                    updateSSEConnectionStatus('connected');
                    sseReconnectAttempts = 0;
                    
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º HTTP polling –µ—Å–ª–∏ –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω
                    if (performancePollingInterval) {
                        clearInterval(performancePollingInterval);
                        performancePollingInterval = null;
                        console.log('‚èπÔ∏è Stopped HTTP polling - SSE active');
                    }
                };
                
                performanceSSE.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('üì° –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê SSE: Performance Metrics received:', data);
                        console.log('üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê SSE: Data structure analysis:');
                        console.log('  - responseTime:', data.responseTime, 'type:', typeof data.responseTime);
                        console.log('  - memoryUsage:', data.memoryUsage, 'type:', typeof data.memoryUsage);
                        console.log('  - cacheHitRatio:', data.cacheHitRatio, 'type:', typeof data.cacheHitRatio);
                        console.log('  - averageResponseTime:', data.averageResponseTime, 'type:', typeof data.averageResponseTime);
                        console.log('  - memoryUsagePercent:', data.memoryUsagePercent, 'type:', typeof data.memoryUsagePercent);
                        handleSSEPerformanceMetrics(data);
                    } catch (e) {
                        console.error('‚ùå –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê SSE: Error parsing SSE Performance Metrics data:', e);
                        console.error('‚ùå –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê SSE: Raw event data:', event.data);
                    }
                };
                
                performanceSSE.addEventListener('performance-metrics', function(event) {
                    try {
                        const metrics = JSON.parse(event.data);
                        console.log('üìä SSE Performance Metrics update:', metrics);
                        handleSSEPerformanceMetrics(metrics);
                    } catch (e) {
                        console.error('‚ùå Error handling SSE performance-metrics event:', e);
                    }
                });
                
                performanceSSE.addEventListener('connected', function(event) {
                    try {
                        const connectionInfo = JSON.parse(event.data);
                        console.log('üîó SSE Connection established:', connectionInfo);
                        updateSSEConnectionStatus('connected');
                    } catch (e) {
                        console.error('‚ùå Error handling SSE connected event:', e);
                    }
                });
                
                performanceSSE.onerror = function(event) {
                    console.error('‚ùå SSE Performance Metrics connection error:', event);
                    console.error('‚ùå –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê SSE: Error details - readyState:', performanceSSE.readyState);
                    console.error('‚ùå –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê SSE: Error event type:', event.type);
                    console.error('‚ùå –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê SSE: Connection URL:', '/admin/api/metrics/stream');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
                    if (performanceSSE.readyState === EventSource.CLOSED) {
                        console.error('‚ùå –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê SSE: Connection closed by server - –≤–æ–∑–º–æ–∂–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π');
                    } else if (performanceSSE.readyState === EventSource.CONNECTING) {
                        console.error('‚ùå –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê SSE: Still trying to connect - –≤–æ–∑–º–æ–∂–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ç—å—é –∏–ª–∏ CORS');
                    }
                    
                    updateSSEConnectionStatus('error');
                    handleSSEError();
                };
                
            } catch (error) {
                console.error('‚ùå Failed to initialize SSE:', error);
                updateSSEConnectionStatus('error');
                fallbackToPerformancePolling();
            }
        }
        
        /**
         * –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö Performance Metrics –æ—Ç SSE
         */
        function handleSSEPerformanceMetrics(metrics) {
            console.log('üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê HANDLER: Starting handleSSEPerformanceMetrics with data:', metrics);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º Performance Metrics —ç–ª–µ–º–µ–Ω—Ç—ã
            const responseTimeEl = document.getElementById('response-time');
            const memoryUsageEl = document.getElementById('memory-usage');
            const cacheHitsEl = document.getElementById('cache-hits');
            
            console.log('üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê HANDLER: DOM elements found:');
            console.log('  - responseTimeEl:', !!responseTimeEl, 'current value:', responseTimeEl?.textContent);
            console.log('  - memoryUsageEl:', !!memoryUsageEl, 'current value:', memoryUsageEl?.textContent);
            console.log('  - cacheHitsEl:', !!cacheHitsEl, 'current value:', cacheHitsEl?.textContent);
            
            // –ü–æ–ø—Ä–æ–±—É–µ–º –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –∏–º–µ–Ω –ø–æ–ª–µ–π –¥–ª—è responseTime
            let responseTimeValue = metrics.responseTime || metrics.averageResponseTime;
            if (responseTimeEl && responseTimeValue !== undefined) {
                const responseTime = Math.round(responseTimeValue);
                responseTimeEl.textContent = responseTime + 'ms';
                console.log('‚úÖ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê HANDLER: Response time updated to:', responseTime + 'ms');
                
                // –ú–∏–≥–∞–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                const responseIndicator = document.getElementById('response-indicator');
                if (responseIndicator) {
                    responseIndicator.className = 'fas fa-circle text-warning';
                    setTimeout(() => {
                        responseIndicator.className = 'fas fa-circle text-success';
                    }, 200);
                }
                
                console.log('‚úÖ SSE Response time updated:', responseTime + 'ms');
            }
            
            // –ü–æ–ø—Ä–æ–±—É–µ–º –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –∏–º–µ–Ω –ø–æ–ª–µ–π –¥–ª—è memoryUsage
            let memoryUsageValue = metrics.memoryUsage || metrics.memoryUsagePercent;
            if (memoryUsageEl && memoryUsageValue !== undefined) {
                memoryUsageEl.textContent = memoryUsageValue + '%';
                console.log('‚úÖ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê HANDLER: Memory usage updated to:', memoryUsageValue + '%');
                
                // –ú–∏–≥–∞–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                const memoryIndicator = document.getElementById('memory-indicator');
                if (memoryIndicator) {
                    memoryIndicator.className = 'fas fa-circle text-warning';
                    setTimeout(() => {
                        memoryIndicator.className = 'fas fa-circle text-success';
                    }, 200);
                }
                
                // –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è —É—Ä–æ–≤–Ω—è –ø–∞–º—è—Ç–∏
                if (memoryUsageValue > 80) {
                    memoryUsageEl.style.color = '#dc3545'; // –ö—Ä–∞—Å–Ω—ã–π
                } else if (memoryUsageValue > 60) {
                    memoryUsageEl.style.color = '#ffc107'; // –ñ–µ–ª—Ç—ã–π
                } else {
                    memoryUsageEl.style.color = '#17a2b8'; // –°–∏–Ω–∏–π
                }
            } else {
                console.warn('‚ö†Ô∏è –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê HANDLER: Memory usage field not found or undefined');
                console.warn('  - metrics.memoryUsage:', metrics.memoryUsage);
                console.warn('  - metrics.memoryUsagePercent:', metrics.memoryUsagePercent);
            }
            
            if (cacheHitsEl && metrics.cacheHitRatio !== undefined) {
                cacheHitsEl.textContent = metrics.cacheHitRatio + '%';
                console.log('‚úÖ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê HANDLER: Cache hits updated to:', metrics.cacheHitRatio + '%');
                
                // –ú–∏–≥–∞–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                const cacheIndicator = document.getElementById('cache-indicator');
                if (cacheIndicator) {
                    cacheIndicator.className = 'fas fa-circle text-warning';
                    setTimeout(() => {
                        cacheIndicator.className = 'fas fa-circle text-success';
                    }, 200);
                }
                
                // –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫—ç—à–∞
                if (metrics.cacheHitRatio > 90) {
                    cacheHitsEl.style.color = '#28a745'; // –ó–µ–ª–µ–Ω—ã–π
                } else if (metrics.cacheHitRatio > 75) {
                    cacheHitsEl.style.color = '#17a2b8'; // –°–∏–Ω–∏–π
                } else {
                    cacheHitsEl.style.color = '#ffc107'; // –ñ–µ–ª—Ç—ã–π
                }
            } else {
                console.warn('‚ö†Ô∏è –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê HANDLER: Cache hit ratio field not found or undefined');
                console.warn('  - metrics.cacheHitRatio:', metrics.cacheHitRatio);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            const lastUpdateEl = document.getElementById('metrics-last-update');
            if (lastUpdateEl) {
                lastUpdateEl.textContent = new Date().toLocaleTimeString('ru-RU') + ' (SSE)';
            }
            
            // –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê Database & Cache –º–µ—Ç—Ä–∏–∫–∏ - –î–ï–¢–ê–õ–¨–ù–û–ï –õ–û–ì–ò–†–û–í–ê–ù–ò–ï
            console.log('üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE JS: === –ê–ù–ê–õ–ò–ó DATABASE & CACHE –ü–û–õ–ï–ô ===');
            console.log('üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE JS: dbPoolUsage field in metrics:',
                'dbPoolUsage' in metrics, 'value:', metrics.dbPoolUsage, 'type:', typeof metrics.dbPoolUsage);
            console.log('üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE JS: cacheMissRatio field in metrics:',
                'cacheMissRatio' in metrics, 'value:', metrics.cacheMissRatio, 'type:', typeof metrics.cacheMissRatio);
            console.log('üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE JS: activeDbConnections field in metrics:',
                'activeDbConnections' in metrics, 'value:', metrics.activeDbConnections, 'type:', typeof metrics.activeDbConnections);

            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–≤—ã–µ Database & Cache –º–µ—Ç—Ä–∏–∫–∏ —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π
            if (metrics.dbPoolUsage !== undefined && metrics.dbPoolUsage !== null) {
                console.log('‚úÖ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE JS: dbPoolUsage –Ω–∞–π–¥–µ–Ω, –∑–Ω–∞—á–µ–Ω–∏–µ:', metrics.dbPoolUsage);
                const dbPoolUsageEl = document.getElementById('db-pool-usage');
                console.log('üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE JS: db-pool-usage —ç–ª–µ–º–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω:', !!dbPoolUsageEl);
                
                if (dbPoolUsageEl) {
                    const displayValue = metrics.dbPoolUsage + '%';
                    dbPoolUsageEl.textContent = displayValue;
                    console.log('‚úÖ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE JS: db-pool-usage –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞:', displayValue);
                    
                    // –ú–∏–≥–∞–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                    const dbPoolIndicator = document.getElementById('db-pool-indicator');
                    if (dbPoolIndicator) {
                        dbPoolIndicator.className = 'fas fa-circle text-warning';
                        setTimeout(() => {
                            dbPoolIndicator.className = 'fas fa-circle text-success';
                        }, 200);
                    }
                    
                    // –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è —É—Ä–æ–≤–Ω—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—É–ª–∞
                    if (metrics.dbPoolUsage > 80) {
                        dbPoolUsageEl.style.color = '#dc3545'; // –ö—Ä–∞—Å–Ω—ã–π
                    } else if (metrics.dbPoolUsage > 60) {
                        dbPoolUsageEl.style.color = '#ffc107'; // –ñ–µ–ª—Ç—ã–π
                    } else {
                        dbPoolUsageEl.style.color = '#007bff'; // –°–∏–Ω–∏–π
                    }
                } else {
                    console.error('‚ùå –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE JS: db-pool-usage —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM!');
                }
            } else {
                console.warn('‚ö†Ô∏è –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE JS: dbPoolUsage –ù–ï –ù–ê–ô–î–ï–ù –≤ metrics –∏–ª–∏ undefined');
            }
            
            if (metrics.cacheMissRatio !== undefined && metrics.cacheMissRatio !== null) {
                console.log('‚úÖ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE JS: cacheMissRatio –Ω–∞–π–¥–µ–Ω, –∑–Ω–∞—á–µ–Ω–∏–µ:', metrics.cacheMissRatio);
                const cacheMissRatioEl = document.getElementById('cache-miss-ratio');
                console.log('üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE JS: cache-miss-ratio —ç–ª–µ–º–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω:', !!cacheMissRatioEl);
                
                if (cacheMissRatioEl) {
                    const displayValue = metrics.cacheMissRatio + '%';
                    cacheMissRatioEl.textContent = displayValue;
                    console.log('‚úÖ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE JS: cache-miss-ratio –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞:', displayValue);
                    
                    // –ú–∏–≥–∞–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                    const cacheMissIndicator = document.getElementById('cache-miss-indicator');
                    if (cacheMissIndicator) {
                        cacheMissIndicator.className = 'fas fa-circle text-warning';
                        setTimeout(() => {
                            cacheMissIndicator.className = 'fas fa-circle text-success';
                        }, 200);
                    }
                    
                    // –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è Cache Miss Ratio (–º–µ–Ω—å—à–µ = –ª—É—á—à–µ)
                    if (metrics.cacheMissRatio < 5) {
                        cacheMissRatioEl.style.color = '#28a745'; // –ó–µ–ª–µ–Ω—ã–π
                    } else if (metrics.cacheMissRatio < 15) {
                        cacheMissRatioEl.style.color = '#ffc107'; // –ñ–µ–ª—Ç—ã–π
                    } else {
                        cacheMissRatioEl.style.color = '#dc3545'; // –ö—Ä–∞—Å–Ω—ã–π
                    }
                } else {
                    console.error('‚ùå –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE JS: cache-miss-ratio —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM!');
                }
            } else {
                console.warn('‚ö†Ô∏è –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE JS: cacheMissRatio –ù–ï –ù–ê–ô–î–ï–ù –≤ metrics –∏–ª–∏ undefined');
            }
            
            if (metrics.activeDbConnections !== undefined && metrics.activeDbConnections !== null) {
                console.log('‚úÖ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE JS: activeDbConnections –Ω–∞–π–¥–µ–Ω, –∑–Ω–∞—á–µ–Ω–∏–µ:', metrics.activeDbConnections);
                const activeDbConnectionsEl = document.getElementById('active-db-connections');
                console.log('üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE JS: active-db-connections —ç–ª–µ–º–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω:', !!activeDbConnectionsEl);
                
                if (activeDbConnectionsEl) {
                    const displayValue = metrics.activeDbConnections.toString();
                    activeDbConnectionsEl.textContent = displayValue;
                    console.log('‚úÖ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE JS: active-db-connections –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞:', displayValue);
                    
                    // –ú–∏–≥–∞–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                    const dbConnectionsIndicator = document.getElementById('db-connections-indicator');
                    if (dbConnectionsIndicator) {
                        dbConnectionsIndicator.className = 'fas fa-circle text-warning';
                        setTimeout(() => {
                            dbConnectionsIndicator.className = 'fas fa-circle text-success';
                        }, 200);
                    }
                    
                    // –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
                    if (metrics.activeDbConnections > 10) {
                        activeDbConnectionsEl.style.color = '#dc3545'; // –ö—Ä–∞—Å–Ω—ã–π
                    } else if (metrics.activeDbConnections > 5) {
                        activeDbConnectionsEl.style.color = '#ffc107'; // –ñ–µ–ª—Ç—ã–π
                    } else {
                        activeDbConnectionsEl.style.color = '#17a2b8'; // –°–∏–Ω–∏–π
                    }
                } else {
                    console.error('‚ùå –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE JS: active-db-connections —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM!');
                }
            } else {
                console.warn('‚ö†Ô∏è –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE JS: activeDbConnections –ù–ï –ù–ê–ô–î–ï–ù –≤ metrics –∏–ª–∏ undefined');
            }
            
            console.log('üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE JS: === –ö–û–ù–ï–¶ –ê–ù–ê–õ–ò–ó–ê DATABASE & CACHE ===');
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Redis —Å—Ç–∞—Ç—É—Å–∞ –∏–∑ SSE –¥–∞–Ω–Ω—ã—Ö
            if (typeof metrics.redis_healthy !== 'undefined') {
                updateRedisStatus(metrics.redis_healthy);
            }
        }
        
        /**
         * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Redis —Å—Ç–∞—Ç—É—Å–∞ –∏–∑ SSE –¥–∞–Ω–Ω—ã—Ö
         */
        function updateRedisStatus(redisHealthy) {
            
            const redisStatus = document.getElementById('redis-status');
            const redisText = document.getElementById('redis-text');
            
            if (redisStatus && redisText) {
                if (redisHealthy === true) {
                    redisStatus.className = redisStatus.className.replace(/bg-\w+/, 'bg-success');
                    redisStatus.innerHTML = '<i class="fas fa-check text-white"></i>';
                    redisText.textContent = 'Connected';
                    redisText.className = 'text-success';
                } else {
                    redisStatus.className = redisStatus.className.replace(/bg-\w+/, 'bg-warning');
                    redisStatus.innerHTML = '<i class="fas fa-exclamation text-white"></i>';
                    redisText.textContent = 'Fallback Mode';
                    redisText.className = 'text-warning';
                }
            } else {
                console.warn('‚ö†Ô∏è –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: Redis status elements not found');
            }
        }
        
        /**
         * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ SSE –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ UI
         */
        function updateSSEConnectionStatus(status) {
            sseConnectionStatus = status;
            
            const indicators = ['response-indicator', 'memory-indicator', 'cache-indicator', 'db-pool-indicator', 'cache-miss-indicator', 'db-connections-indicator'];
            const statusColors = {
                'disconnected': 'text-secondary',
                'connecting': 'text-warning',
                'connected': 'text-success',
                'error': 'text-danger'
            };
            
            const statusTexts = {
                'disconnected': 'Offline',
                'connecting': 'Connecting...',
                'connected': 'Live',
                'error': 'Error'
            };
            
            indicators.forEach(indicatorId => {
                const indicator = document.getElementById(indicatorId);
                if (indicator) {
                    indicator.className = `fas fa-circle ${statusColors[status] || 'text-secondary'}`;
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞
            const statusElements = document.querySelectorAll('.ms-1');
            statusElements.forEach(el => {
                if (el.textContent === 'Live' || el.textContent === 'Offline' ||
                    el.textContent === 'Connecting...' || el.textContent === 'Error') {
                    el.textContent = statusTexts[status] || 'Unknown';
                }
            });
            
            // –ù–û–í–û–ï: –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ SSE —Å–æ—Å—Ç–æ—è–Ω–∏—è
            if (status === 'connected') {
                // –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º SSE –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ - —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç
                updateSystemStatus('application', true);
                updateSystemStatus('telegram-bot', true);
            } else if (status === 'error' || status === 'disconnected') {
                // –ü—Ä–∏ –ø–æ—Ç–µ—Ä–µ SSE - —Å–∏—Å—Ç–µ–º—ã –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
                updateSystemStatus('application', false);
                updateSystemStatus('telegram-bot', false);
            }
            
            console.log('üìä SSE Connection status updated:', status);
        }
        
        /**
         * –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ SSE –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
         */
        function handleSSEError() {
            if (sseReconnectAttempts < maxSSEReconnectAttempts) {
                sseReconnectAttempts++;
                const reconnectDelay = Math.min(1000 * Math.pow(2, sseReconnectAttempts), 30000); // Exponential backoff
                
                console.log(`üîÑ SSE reconnection attempt ${sseReconnectAttempts}/${maxSSEReconnectAttempts} in ${reconnectDelay}ms`);
                
                sseReconnectTimeout = setTimeout(() => {
                    reconnectSSE();
                }, reconnectDelay);
            } else {
                console.warn('‚ö†Ô∏è SSE max reconnection attempts reached, falling back to HTTP polling');
                fallbackToPerformancePolling();
            }
        }
        
        /**
         * –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ SSE
         */
        function reconnectSSE() {
            if (performanceSSE) {
                performanceSSE.close();
                performanceSSE = null;
            }
            
            updateSSEConnectionStatus('connecting');
            setTimeout(() => {
                initPerformanceSSE();
            }, 100);
        }
        
        /**
         * Fallback –Ω–∞ HTTP polling –∫–æ–≥–¥–∞ SSE –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
         */
        function fallbackToPerformancePolling() {
            console.log('üîÑ Activating HTTP polling fallback for Performance Metrics');
            updateSSEConnectionStatus('disconnected');
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º SSE –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç
            if (performanceSSE) {
                performanceSSE.close();
                performanceSSE = null;
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º HTTP polling –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            if (!performancePollingInterval) {
                performancePollingInterval = setInterval(() => {
                    updatePerformanceMetricsHTTP();
                }, 5000);
                console.log('‚è∞ HTTP polling started with 5s interval');
            }
        }
        
        /**
         * HTTP fallback –¥–ª—è Performance Metrics
         */
        function updatePerformanceMetricsHTTP() {
            fetch('/admin/api/metrics/current')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(result => {
                    if (result.success && result.data) {
                        console.log('üìä HTTP Performance Metrics received:', result.data);
                        handleSSEPerformanceMetrics(result.data); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ handler
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è —Å –ø–æ–º–µ—Ç–∫–æ–π HTTP
                        const lastUpdateEl = document.getElementById('metrics-last-update');
                        if (lastUpdateEl) {
                            lastUpdateEl.textContent = new Date().toLocaleTimeString('ru-RU') + ' (HTTP)';
                        }
                    }
                })
                .catch(error => {
                    console.error('‚ùå HTTP Performance Metrics failed:', error);
                    // Fallback –∫ —Å—Ç–∞—Ä—ã–º –º–µ—Ç–æ–¥–∞–º
                    updatePerformanceMetricsOnly();
                });
        }
        
        // Override global refresh function
        function refreshData() {
            console.log('üîÑ Refresh data called');
            showLoading();
            updateSystemMetrics();
            refreshActivity();
            setTimeout(hideLoading, 1000);
        }
        
        function updateSystemMetrics() {
            
            // –ü–æ–ª—É—á–∞–µ–º Environment Info
            updateEnvironmentInfoFromAPI();
            
            // Fetch real system health data
            fetch('/admin/api/system-health')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(healthData => {
                    
                    // Update real performance metrics from system health
                    const responseTimeEl = document.getElementById('response-time');
                    const memoryUsageEl = document.getElementById('memory-usage');
                    const cacheHitsEl = document.getElementById('cache-hits');
                    
                    if (responseTimeEl && healthData.averageResponseTime !== undefined) {
                        const responseTime = Math.round(healthData.averageResponseTime);
                        responseTimeEl.textContent = responseTime + 'ms';
                        console.log('‚úÖ Response time updated:', responseTime + 'ms');
                    }
                    if (memoryUsageEl && healthData.memoryUsagePercent !== undefined) {
                        memoryUsageEl.textContent = healthData.memoryUsagePercent + '%';
                        console.log('‚úÖ Memory usage updated:', healthData.memoryUsagePercent + '%');
                    }
                    if (cacheHitsEl && healthData.cacheHitRatio !== undefined) {
                        cacheHitsEl.textContent = healthData.cacheHitRatio + '%';
                        console.log('‚úÖ Cache hits updated:', healthData.cacheHitRatio + '%');
                    }
                    
                    // –ö–†–ò–¢–ò–ß–ù–û: –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∑–∞–∫–∞–∑–æ–≤
                    const totalUsersEl = document.getElementById('total-users');
                    const activeUsersEl = document.getElementById('active-users');
                    const totalOrdersEl = document.getElementById('total-orders');
                    
                    if (totalUsersEl && healthData.totalUsers !== undefined) {
                        totalUsersEl.textContent = healthData.totalUsers;
                        console.log('‚úÖ Total users updated:', healthData.totalUsers);
                    }
                    if (activeUsersEl && healthData.activeUsers !== undefined) {
                        activeUsersEl.textContent = healthData.activeUsers;
                        console.log('‚úÖ Active users updated:', healthData.activeUsers);
                    }
                    if (totalOrdersEl && healthData.totalOrders !== undefined) {
                        totalOrdersEl.textContent = healthData.totalOrders;
                        console.log('‚úÖ Total orders updated:', healthData.totalOrders);
                    }
                    
                    // Update system status indicators
                    updateSystemStatusIndicators(healthData);
                    
                    // –ù–û–í–û–ï: –û–±–Ω–æ–≤–ª—è–µ–º Health Score
                    updateHealthScore(healthData);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–æ—Å–Ω–æ–≤–Ω–æ–π endpoint)
                    const lastUpdateEl = document.getElementById('metrics-last-update');
                    if (lastUpdateEl) {
                        lastUpdateEl.textContent = new Date().toLocaleTimeString('ru-RU');
                    }
                })
                .catch(error => {
                    console.error('‚ùå –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: Could not fetch system health:', error);
                    console.error('‚ùå –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: Error type:', error.constructor.name);
                    console.error('‚ùå –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: Error message:', error.message);
                    console.error('‚ùå –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: Error stack:', error.stack);
                    // Fallback to simulated metrics
                    const responseTimeEl = document.getElementById('response-time');
                    const memoryUsageEl = document.getElementById('memory-usage');
                    const cacheHitsEl = document.getElementById('cache-hits');
                    
                    // Fallback performance metrics - –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                    if (responseTimeEl) {
                        const fallbackResponseTime = (Math.random() * 30 + 45).toFixed(0);
                        responseTimeEl.textContent = fallbackResponseTime + 'ms';
                        console.log('üîÑ Fallback response time:', fallbackResponseTime + 'ms');
                    }
                    if (memoryUsageEl) {
                        const fallbackMemory = (Math.random() * 25 + 55).toFixed(0);
                        memoryUsageEl.textContent = fallbackMemory + '%';
                        console.log('üîÑ Fallback memory usage:', fallbackMemory + '%');
                    }
                    if (cacheHitsEl) {
                        const fallbackCache = (Math.random() * 12 + 88).toFixed(0);
                        cacheHitsEl.textContent = fallbackCache + '%';
                        console.log('üîÑ Fallback cache hits:', fallbackCache + '%');
                    }
                    
                    // Fallback –¥–ª—è —Å—á–µ—Ç—á–∏–∫–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    updateUserCountsFallback();
                    
                    // Fallback –¥–ª—è Health Score - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                    updateHealthScore({ healthScore: 75 }); // Fallback –∑–Ω–∞—á–µ–Ω–∏–µ 75%
                });
            
            // Update uptime
            updateUptime();
            
            // Update flags progress
            updateFlagsProgress();
        }
        
        // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è fallback –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ + Performance Metrics
        function updateUserCountsFallback() {
            console.log('üîÑ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê FALLBACK: Attempting to fetch /admin/api/monitoring-fast');
            
            fetch('/admin/api/monitoring-fast')
                .then(response => {
                    console.log('üì° –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê FALLBACK: monitoring-fast response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('üìä –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê FALLBACK: monitoring-fast data received:', data);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    const totalUsersEl = document.getElementById('total-users');
                    const activeUsersEl = document.getElementById('active-users');
                    const totalOrdersEl = document.getElementById('total-orders');
                    
                    if (totalUsersEl && data.totalUsers !== undefined) {
                        totalUsersEl.textContent = data.totalUsers;
                    }
                    if (activeUsersEl && data.activeUsers !== undefined) {
                        activeUsersEl.textContent = data.activeUsers;
                    }
                    if (totalOrdersEl && data.totalOrders !== undefined) {
                        totalOrdersEl.textContent = data.totalOrders || '0';
                    }
                    
                    // –ù–û–í–û–ï: –û–±–Ω–æ–≤–ª—è–µ–º Performance Metrics –∏–∑ fast endpoint
                    const responseTimeEl = document.getElementById('response-time');
                    const memoryUsageEl = document.getElementById('memory-usage');
                    const cacheHitsEl = document.getElementById('cache-hits');
                    
                    if (responseTimeEl && data.averageResponseTime !== undefined) {
                        const responseTime = Math.round(data.averageResponseTime);
                        responseTimeEl.textContent = responseTime + 'ms';
                        console.log('‚úÖ Fast endpoint response time updated:', responseTime + 'ms');
                    }
                    if (memoryUsageEl && data.memoryUsagePercent !== undefined) {
                        memoryUsageEl.textContent = data.memoryUsagePercent + '%';
                        console.log('‚úÖ Fast endpoint memory usage updated:', data.memoryUsagePercent + '%');
                    }
                    if (cacheHitsEl && data.cacheHitRatio !== undefined) {
                        cacheHitsEl.textContent = data.cacheHitRatio + '%';
                        console.log('‚úÖ Fast endpoint cache hits updated:', data.cacheHitRatio + '%');
                    }
                    
                    // –ù–û–í–û–ï: –û–±–Ω–æ–≤–ª—è–µ–º Database & Cache –º–µ—Ç—Ä–∏–∫–∏ –∏–∑ fast endpoint
                    const dbPoolUsageEl = document.getElementById('db-pool-usage');
                    const cacheMissRatioEl = document.getElementById('cache-miss-ratio');
                    const activeDbConnectionsEl = document.getElementById('active-db-connections');
                    
                    if (dbPoolUsageEl && data.dbPoolUsage !== undefined && data.dbPoolUsage !== null) {
                        dbPoolUsageEl.textContent = data.dbPoolUsage + '%';
                        console.log('‚úÖ Fast endpoint DB pool usage updated:', data.dbPoolUsage + '%');
                    }
                    if (cacheMissRatioEl && data.cacheMissRatio !== undefined && data.cacheMissRatio !== null) {
                        cacheMissRatioEl.textContent = data.cacheMissRatio + '%';
                        console.log('‚úÖ Fast endpoint cache miss ratio updated:', data.cacheMissRatio + '%');
                    }
                    if (activeDbConnectionsEl && data.activeDbConnections !== undefined && data.activeDbConnections !== null) {
                        activeDbConnectionsEl.textContent = data.activeDbConnections.toString();
                        console.log('‚úÖ Fast endpoint active DB connections updated:', data.activeDbConnections);
                    }
                    
                    // –ù–û–í–û–ï: –û–±–Ω–æ–≤–ª—è–µ–º Health Score –∏–∑ fast endpoint
                    if (data.healthScore !== undefined || data.health_score !== undefined) {
                        updateHealthScore(data);
                        console.log('‚úÖ Fast endpoint health score updated');
                    }
                })
                .catch(error => {
                    console.error('‚ùå –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: Fast monitoring fallback failed:', error);
                    console.error('‚ùå –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: Fallback error type:', error.constructor.name);
                    // –ü–æ—Å–ª–µ–¥–Ω–∏–π fallback - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º Loading...
                    const totalUsersEl = document.getElementById('total-users');
                    const activeUsersEl = document.getElementById('active-users');
                    const totalOrdersEl = document.getElementById('total-orders');
                    
                    if (totalUsersEl) totalUsersEl.textContent = 'Loading...';
                    if (activeUsersEl) activeUsersEl.textContent = 'Loading...';
                    if (totalOrdersEl) totalOrdersEl.textContent = 'Loading...';
                });
        }
        
        /**
         * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ –ë–ï–ó Performance Metrics (–æ–Ω–∏ –∏–¥—É—Ç —á–µ—Ä–µ–∑ SSE)
         */
        function updateSystemMetricsExcludingPerformance() {
            
            // –ü–æ–ª—É—á–∞–µ–º Environment Info
            updateEnvironmentInfoFromAPI();
            
            // Fetch real system health data
            fetch('/admin/api/system-health')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(healthData => {
                    
                    // –ù–ï –æ–±–Ω–æ–≤–ª—è–µ–º Performance Metrics - –æ–Ω–∏ –∏–¥—É—Ç —á–µ—Ä–µ–∑ SSE
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å—á–µ—Ç—á–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∑–∞–∫–∞–∑–æ–≤
                    const totalUsersEl = document.getElementById('total-users');
                    const activeUsersEl = document.getElementById('active-users');
                    const totalOrdersEl = document.getElementById('total-orders');
                    
                    if (totalUsersEl && healthData.totalUsers !== undefined) {
                        totalUsersEl.textContent = healthData.totalUsers;
                        console.log('‚úÖ Total users updated:', healthData.totalUsers);
                    }
                    if (activeUsersEl && healthData.activeUsers !== undefined) {
                        activeUsersEl.textContent = healthData.activeUsers;
                        console.log('‚úÖ Active users updated:', healthData.activeUsers);
                    }
                    if (totalOrdersEl && healthData.totalOrders !== undefined) {
                        totalOrdersEl.textContent = healthData.totalOrders;
                        console.log('‚úÖ Total orders updated:', healthData.totalOrders);
                    }
                    
                    // Update system status indicators
                    updateSystemStatusIndicators(healthData);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º Health Score
                    updateHealthScore(healthData);
                })
                .catch(error => {
                    console.error('‚ùå –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: Could not fetch system health:', error);
                    // –ü—Ä–∏ –æ—à–∏–±–∫–µ —Å–∏—Å—Ç–µ–º—ã —Å—á–∏—Ç–∞—é—Ç—Å—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º–∏
                    updateSystemStatus('application', false);
                    updateSystemStatus('telegram-bot', false);
                    
                    // Fallback –∫ fast endpoint –¥–ª—è —Å—á–µ—Ç—á–∏–∫–æ–≤
                    updateUserCountsFallbackExcludingPerformance();
                });
            
            // Update uptime
            updateUptime();
        }
        
        /**
         * Fallback –¥–ª—è —Å—á–µ—Ç—á–∏–∫–æ–≤ –ë–ï–ó Performance Metrics
         */
        function updateUserCountsFallbackExcludingPerformance() {
            
            fetch('/admin/api/monitoring-fast')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¢–û–õ–¨–ö–û —Å—á–µ—Ç—á–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ù–ï Performance Metrics
                    const totalUsersEl = document.getElementById('total-users');
                    const activeUsersEl = document.getElementById('active-users');
                    const totalOrdersEl = document.getElementById('total-orders');
                    
                    if (totalUsersEl && data.totalUsers !== undefined) {
                        totalUsersEl.textContent = data.totalUsers;
                    }
                    if (activeUsersEl && data.activeUsers !== undefined) {
                        activeUsersEl.textContent = data.activeUsers;
                    }
                    if (totalOrdersEl && data.totalOrders !== undefined) {
                        totalOrdersEl.textContent = data.totalOrders || '0';
                    }
                    
                    // –ù–û–í–û–ï: –ü—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º –∏–∑ fast endpoint
                    if (data.success) {
                        updateSystemStatus('application', true);
                        updateSystemStatus('telegram-bot', data.totalUsers !== undefined);
                    }
                })
                .catch(error => {
                    console.error('‚ùå –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: Fast monitoring fallback failed:', error);
                    
                    // –ü—Ä–∏ –ø–æ–ª–Ω–æ–º –ø—Ä–æ–≤–∞–ª–µ - —Å–∏—Å—Ç–µ–º—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
                    updateSystemStatus('application', false);
                    updateSystemStatus('telegram-bot', false);
                    
                    // –ü–æ—Å–ª–µ–¥–Ω–∏–π fallback - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º Loading...
                    const totalUsersEl = document.getElementById('total-users');
                    const activeUsersEl = document.getElementById('active-users');
                    const totalOrdersEl = document.getElementById('total-orders');
                    
                    if (totalUsersEl) totalUsersEl.textContent = 'Loading...';
                    if (activeUsersEl) activeUsersEl.textContent = 'Loading...';
                    if (totalOrdersEl) totalOrdersEl.textContent = 'Loading...';
                    
                    // –ü–æ—Å–ª–µ–¥–Ω–∏–π fallback –¥–ª—è Health Score
                    updateHealthScore({ healthScore: 70 }); // –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ–µ fallback –∑–Ω–∞—á–µ–Ω–∏–µ
                });
        }
        
        function updateSystemStatusIndicators(healthData) {
            
            // Update Redis status based on real data
            const redisStatus = document.getElementById('redis-status');
            const redisText = document.getElementById('redis-text');
            
            if (redisStatus && redisText) {
                // –ï—Å–ª–∏ Redis —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω —á–µ—Ä–µ–∑ SSE - –Ω–µ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—Ç—å
                const currentRedisStatus = redisText ? redisText.textContent.trim() : '';
                
                // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ª–æ–≥–∏–∫–∞: —É—á–µ—Ç —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –¥–∞–Ω–Ω—ã—Ö
                const redisHealthy = healthData.redis_healthy || healthData.redisHealthy;
                
                if (currentRedisStatus === 'Connected' && redisHealthy !== false) {
                    // –ù–ï –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—Ç—å —Å—Ç–∞—Ç—É—Å Connected –∏–∑ SSE
                } else if (redisHealthy === true) {
                    redisStatus.className = redisStatus.className.replace(/bg-\w+/, 'bg-success');
                    redisStatus.innerHTML = '<i class="fas fa-check text-white"></i>';
                    redisText.textContent = 'Connected';
                    redisText.className = 'text-success';
                } else if (redisHealthy === false) {
                    redisStatus.className = redisStatus.className.replace(/bg-\w+/, 'bg-warning');
                    redisStatus.innerHTML = '<i class="fas fa-exclamation text-white"></i>';
                    redisText.textContent = 'Fallback Mode';
                    redisText.className = 'text-warning';
                } else {
                    // –ï—Å–ª–∏ –ø–æ–ª–µ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ - –ù–ï –∏–∑–º–µ–Ω—è—Ç—å —Å—Ç–∞—Ç—É—Å
                }
            } else {
                console.warn('‚ö†Ô∏è –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: Redis status elements not found');
            }
            
            // –ù–û–í–û–ï: –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ –∑–¥–æ—Ä–æ–≤—å–µ
            updateSystemStatusFromHealthData(healthData);
        }
        
        /**
         * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –æ –∑–¥–æ—Ä–æ–≤—å–µ —Å–∏—Å—Ç–µ–º—ã
         */
        function updateSystemStatusFromHealthData(healthData) {
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ SSE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            const sseConnected = performanceSSE && performanceSSE.readyState === EventSource.OPEN;
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ª–æ–≥–∏–∫–∞ –¥–ª—è Application
            let applicationOnline = (healthData.health_score || healthData.healthScore || 0) > 80 && (
                !healthData.average_response_time || healthData.average_response_time < 5000
            );
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–µ SSE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ - Application –æ–Ω–ª–∞–π–Ω
            if (sseConnected) {
                applicationOnline = true; // SSE —Ä–∞–±–æ—Ç–∞–µ—Ç = Application –æ–Ω–ª–∞–π–Ω
            }
            
            updateSystemStatus('application', applicationOnline);
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ª–æ–≥–∏–∫–∞ –¥–ª—è Bot
            const botActive = healthData.bot_healthy === true ||
                healthData.total_users > 0 ||
                healthData.active_users > 0 ||
                healthData.totalUsers > 0 ||
                healthData.activeUsers > 0;
            updateSystemStatus('telegram-bot', botActive);
            
        }
        
        /**
         * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Health Score –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ API
         */
        function updateHealthScore(healthData) {
            console.log('üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: Updating health score from data:', healthData);
            
            // –ü–æ–ª—É—á–∞–µ–º health score –∏–∑ –¥–∞–Ω–Ω—ã—Ö (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞)
            const healthScore = healthData.healthScore || healthData.health_score || 0;
            console.log('üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: Extracted health score value:', healthScore);
            
            const healthProgressBar = document.getElementById('health-progress');
            const healthScoreText = document.getElementById('health-score-text');
            
            if (healthProgressBar && healthScoreText) {
                // –û–±–Ω–æ–≤–ª—è–µ–º —à–∏—Ä–∏–Ω—É –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
                healthProgressBar.style.width = healthScore + '%';
                healthProgressBar.setAttribute('aria-valuenow', healthScore);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
                healthScoreText.textContent = healthScore + '%';
                
                // –ò–∑–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–Ω–∞—á–µ–Ω–∏—è
                healthProgressBar.className = `progress-bar ${getHealthScoreClass(healthScore)}`;
                
            } else {
                console.warn('‚ö†Ô∏è –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: Health score elements not found');
            }
        }
        
        /**
         * –ü–æ–ª—É—á–µ–Ω–∏–µ CSS –∫–ª–∞—Å—Å–∞ –¥–ª—è —Ü–≤–µ—Ç–∞ Health Score
         */
        function getHealthScoreClass(score) {
            if (score >= 90) return 'bg-success';    // –ó–µ–ª–µ–Ω—ã–π –¥–ª—è 90%+
            if (score >= 75) return 'bg-info';       // –°–∏–Ω–∏–π –¥–ª—è 75-89%
            if (score >= 60) return 'bg-warning';    // –ñ–µ–ª—Ç—ã–π –¥–ª—è 60-74%
            return 'bg-danger';                      // –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è <60%
        }
        
        function updateUptime() {
            const now = new Date();
            const diff = now - monitoringStartTime;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            const uptimeEl = document.getElementById('uptime');
            if (uptimeEl) uptimeEl.textContent = `${hours}h ${minutes}m`;
        }
        
        function updateFlagsProgress() {
            const totalFlagsEl = document.getElementById('total-flags');
            const activeFlagsEl = document.getElementById('active-flags');
            const progressEl = document.getElementById('flags-progress');
            
            if (!totalFlagsEl || !activeFlagsEl || !progressEl) return;
            
            const totalFlags = parseInt(totalFlagsEl.textContent) || 0;
            const activeFlags = parseInt(activeFlagsEl.textContent) || 0;
            
            const percentage = totalFlags > 0 ? (activeFlags / totalFlags * 100) : 0;
            progressEl.style.width = percentage + '%';
            progressEl.setAttribute('aria-valuenow', percentage);
        }
        
        function refreshActivity() {
            const activityContainer = document.getElementById('activity-logs');
            
            // Add null check for activity container
            if (!activityContainer) {
                console.warn('Activity container not found');
                return;
            }
            
            // Fetch real recent activity data
            fetch('/admin/api/recent-activity')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(activityData => {
                    activityContainer.innerHTML = '';
                    
                    if (activityData && activityData.recentOrders) {
                        // Display recent orders
                        activityData.recentOrders.forEach(order => {
                            const activityHtml = `
                                <div class="d-flex align-items-start mb-3">
                                    <div class="flex-shrink-0">
                                        <div class="status-indicator bg-success rounded-circle" 
                                             style="width: 10px; height: 10px; margin-top: 6px;"></div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <div class="small">
                                            <strong>Order #${order.id || 'N/A'} - ${order.status || 'Unknown'}</strong>
                                        </div>
                                        <div class="text-muted" style="font-size: 0.75rem;">
                                            ${new Date(order.createdAt || Date.now()).toLocaleTimeString('ru-RU')}
                                        </div>
                                    </div>
                                </div>
                            `;
                            activityContainer.insertAdjacentHTML('beforeend', activityHtml);
                        });
                    }
                    
                    if (activityData && activityData.newUsers) {
                        // Display new users
                        activityData.newUsers.forEach(user => {
                            const activityHtml = `
                                <div class="d-flex align-items-start mb-3">
                                    <div class="flex-shrink-0">
                                        <div class="status-indicator bg-info rounded-circle" 
                                             style="width: 10px; height: 10px; margin-top: 6px;"></div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <div class="small">
                                            <strong>New user: ${user.telegramUsername || user.telegramUserId || 'Anonymous'}</strong>
                                        </div>
                                        <div class="text-muted" style="font-size: 0.75rem;">
                                            ${new Date(user.createdAt || Date.now()).toLocaleTimeString('ru-RU')}
                                        </div>
                                    </div>
                                </div>
                            `;
                            activityContainer.insertAdjacentHTML('beforeend', activityHtml);
                        });
                    }
                    
                    // If no real data available, show empty state
                    if (activityContainer.innerHTML === '') {
                        activityContainer.innerHTML = `
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-clock fa-2x mb-3"></i>
                                <p>No recent activity found</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.warn('Could not fetch recent activity:', error);
                    // Fallback to mock activities
                    const activities = generateMockActivities();
                    
                    activityContainer.innerHTML = '';
                    activities.forEach(activity => {
                        const activityHtml = `
                            <div class="d-flex align-items-start mb-3">
                                <div class="flex-shrink-0">
                                    <div class="status-indicator bg-${activity.type} rounded-circle" 
                                         style="width: 10px; height: 10px; margin-top: 6px;"></div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="small">
                                        <strong>${activity.message}</strong>
                                    </div>
                                    <div class="text-muted" style="font-size: 0.75rem;">
                                        ${activity.timestamp}
                                    </div>
                                </div>
                            </div>
                        `;
                        activityContainer.insertAdjacentHTML('beforeend', activityHtml);
                    });
                });
        }
        
        function generateMockActivities() {
            const types = ['success', 'warning', 'info', 'primary'];
            const messages = [
                'Feature flag "NEW_CHECKOUT" enabled',
                'Cache refreshed successfully', 
                'System health check completed',
                'Redis connection restored',
                'User session updated',
                'Configuration reloaded',
                'Bot message sent successfully',
                'Feature flag "BETA_FEATURES" disabled'
            ];
            
            const activities = [];
            for (let i = 0; i < 8; i++) {
                const now = new Date();
                now.setMinutes(now.getMinutes() - i * 5);
                
                activities.push({
                    type: types[Math.floor(Math.random() * types.length)],
                    message: messages[Math.floor(Math.random() * messages.length)],
                    timestamp: now.toLocaleTimeString('ru-RU')
                });
            }
            
            return activities;
        }
        
        function checkSystemHealth() {
            showToast('Checking system health...', 'info');
            
            // Simulate health check
            setTimeout(() => {
                updateSystemMetrics();
                showToast('System health check completed successfully', 'success');
            }, 2000);
        }
        
        function refreshCache() {
            fetch('/admin/refresh-cache', {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    showToast('Cache refreshed successfully', 'success');
                    updateSystemMetrics();
                } else {
                    showToast('Error refreshing cache', 'danger');
                }
            })
            .catch(error => {
                console.error('Error refreshing cache:', error);
                showToast('Error refreshing cache', 'danger');
            });
        }
        
        function clearLogs() {
            const activityContainer = document.getElementById('activity-logs');
            
            if (!activityContainer) {
                console.warn('Activity container not found');
                return;
            }
            
            activityContainer.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-trash fa-2x mb-3"></i>
                    <p>Activity logs cleared</p>
                </div>
            `;
            showToast('Activity logs cleared', 'info');
        }
        
        function exportDiagnostics() {
            const diagnostics = {
                timestamp: new Date().toISOString(),
                uptime: document.getElementById('uptime').textContent,
                responseTime: document.getElementById('response-time').textContent,
                memoryUsage: document.getElementById('memory-usage').textContent,
                cacheHits: document.getElementById('cache-hits').textContent,
                // –ù–û–í–´–ï Database & Cache –º–µ—Ç—Ä–∏–∫–∏
                dbPoolUsage: document.getElementById('db-pool-usage').textContent,
                cacheMissRatio: document.getElementById('cache-miss-ratio').textContent,
                activeDbConnections: document.getElementById('active-db-connections').textContent,
                totalFlags: document.getElementById('total-flags')?.textContent || 'N/A',
                activeFlags: document.getElementById('active-flags')?.textContent || 'N/A',
                cacheSize: document.getElementById('cache-size').textContent
            };
            
            const blob = new Blob([JSON.stringify(diagnostics, null, 2)], 
                                {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `diagnostics-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Diagnostics exported successfully', 'success');
        }
        
        /**
         * –î–ò–ê–ì–ù–û–°–¢–ò–ß–ï–°–ö–ê–Ø –§–£–ù–ö–¶–ò–Ø: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö Database & Cache –º–µ—Ç—Ä–∏–∫
         */
        function testDatabaseCacheMetrics() {
            console.log('üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE: Testing new Database & Cache metrics...');
            
            fetch('/admin/api/test-db-cache-metrics')
                .then(response => {
                    console.log('üì° –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE: Test response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(result => {
                    console.log('‚úÖ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE: Test results:', result);
                    
                    if (result.success) {
                        console.log('üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE: Calculated metrics:', result.calculatedMetrics);
                        console.log('üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE: Raw connection pool stats:', result.rawConnectionPoolStats);
                        console.log('üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE: Validation results:', result.validation);
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –º–µ—Ç—Ä–∏–∫
                        const validation = result.validation;
                        let validationMessage = 'Database & Cache metrics validation:\n';
                        validationMessage += `- DB Pool Usage Valid: ${validation.dbPoolUsageValid}\n`;
                        validationMessage += `- Cache Miss Ratio Valid: ${validation.cacheMissRatioValid}\n`;
                        validationMessage += `- Active DB Connections Valid: ${validation.activeDbConnectionsValid}\n`;
                        validationMessage += `- Connection Pool Service Available: ${validation.connectionPoolServiceAvailable}`;
                        
                        console.log('üìä –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE: Validation summary:', validationMessage);
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                        const metrics = result.calculatedMetrics;
                        showToast(`DB&Cache Test: Pool=${metrics.dbPoolUsage}%, Miss=${metrics.cacheMissRatio}%, Connections=${metrics.activeDbConnections}`, 'info');
                    } else {
                        console.error('‚ùå –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE: Test failed:', result.error);
                        showToast('Database & Cache metrics test failed', 'danger');
                    }
                })
                .catch(error => {
                    console.error('‚ùå –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê DB&CACHE: Test request failed:', error);
                    showToast('Failed to test Database & Cache metrics', 'danger');
                });
        }
        
        /**
         * –ë—ã—Å—Ç—Ä–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ Performance Metrics –±–µ–∑ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∏—Å—Ç–µ–º—ã
         */
        function updatePerformanceMetricsOnly() {
            fetch('/admin/api/monitoring-fast')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ Performance Metrics —ç–ª–µ–º–µ–Ω—Ç—ã
                        const responseTimeEl = document.getElementById('response-time');
                        const memoryUsageEl = document.getElementById('memory-usage');
                        const cacheHitsEl = document.getElementById('cache-hits');
                        
                        if (responseTimeEl && data.averageResponseTime !== undefined) {
                            const responseTime = Math.round(data.averageResponseTime);
                            responseTimeEl.textContent = responseTime + 'ms';
                            
                            // –ú–∏–≥–∞–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                            const responseIndicator = document.getElementById('response-indicator');
                            if (responseIndicator) {
                                responseIndicator.className = 'fas fa-circle text-warning';
                                setTimeout(() => {
                                    responseIndicator.className = 'fas fa-circle text-success';
                                }, 200);
                            }
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                            responseTimeEl.style.transition = 'color 0.3s ease';
                            responseTimeEl.style.color = '#28a745';
                            setTimeout(() => {
                                responseTimeEl.style.color = '#007bff';
                            }, 300);
                        }
                        
                        if (memoryUsageEl && data.memoryUsagePercent !== undefined) {
                            memoryUsageEl.textContent = data.memoryUsagePercent + '%';
                            
                            // –ú–∏–≥–∞–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                            const memoryIndicator = document.getElementById('memory-indicator');
                            if (memoryIndicator) {
                                memoryIndicator.className = 'fas fa-circle text-warning';
                                setTimeout(() => {
                                    memoryIndicator.className = 'fas fa-circle text-success';
                                }, 200);
                            }
                            
                            // –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è —É—Ä–æ–≤–Ω—è –ø–∞–º—è—Ç–∏
                            if (data.memoryUsagePercent > 80) {
                                memoryUsageEl.style.color = '#dc3545'; // –ö—Ä–∞—Å–Ω—ã–π
                            } else if (data.memoryUsagePercent > 60) {
                                memoryUsageEl.style.color = '#ffc107'; // –ñ–µ–ª—Ç—ã–π
                            } else {
                                memoryUsageEl.style.color = '#17a2b8'; // –°–∏–Ω–∏–π
                            }
                        }
                        
                        if (cacheHitsEl && data.cacheHitRatio !== undefined) {
                            cacheHitsEl.textContent = data.cacheHitRatio + '%';
                            
                            // –ú–∏–≥–∞–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                            const cacheIndicator = document.getElementById('cache-indicator');
                            if (cacheIndicator) {
                                cacheIndicator.className = 'fas fa-circle text-warning';
                                setTimeout(() => {
                                    cacheIndicator.className = 'fas fa-circle text-success';
                                }, 200);
                            }
                            
                            // –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫—ç—à–∞
                            if (data.cacheHitRatio > 90) {
                                cacheHitsEl.style.color = '#28a745'; // –ó–µ–ª–µ–Ω—ã–π
                            } else if (data.cacheHitRatio > 75) {
                                cacheHitsEl.style.color = '#17a2b8'; // –°–∏–Ω–∏–π
                            } else {
                                cacheHitsEl.style.color = '#ffc107'; // –ñ–µ–ª—Ç—ã–π
                            }
                        }
                        
                        // –ù–û–í–û–ï: –û–±–Ω–æ–≤–ª—è–µ–º Database & Cache –º–µ—Ç—Ä–∏–∫–∏
                        const dbPoolUsageEl = document.getElementById('db-pool-usage');
                        const cacheMissRatioEl = document.getElementById('cache-miss-ratio');
                        const activeDbConnectionsEl = document.getElementById('active-db-connections');
                        
                        if (dbPoolUsageEl && data.dbPoolUsage !== undefined && data.dbPoolUsage !== null) {
                            dbPoolUsageEl.textContent = data.dbPoolUsage + '%';
                        }
                        if (cacheMissRatioEl && data.cacheMissRatio !== undefined && data.cacheMissRatio !== null) {
                            cacheMissRatioEl.textContent = data.cacheMissRatio + '%';
                        }
                        if (activeDbConnectionsEl && data.activeDbConnections !== undefined && data.activeDbConnections !== null) {
                            activeDbConnectionsEl.textContent = data.activeDbConnections.toString();
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                        const lastUpdateEl = document.getElementById('metrics-last-update');
                        if (lastUpdateEl) {
                            lastUpdateEl.textContent = new Date().toLocaleTimeString('ru-RU');
                        }
                        
                        console.log('‚ö° Performance metrics updated:', {
                            responseTime: data.averageResponseTime,
                            memory: data.memoryUsagePercent,
                            cache: data.cacheHitRatio,
                            dbPoolUsage: data.dbPoolUsage,
                            cacheMissRatio: data.cacheMissRatio,
                            activeDbConnections: data.activeDbConnections
                        });
                    }
                })
                .catch(error => {
                    console.warn('‚ö†Ô∏è Fast performance metrics update failed:', error);
                    // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–ª—è background –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
                });
        }
        
        /**
         * –ü–æ–ª—É—á–µ–Ω–∏–µ Environment Info –∏–∑ API
         */
        function updateEnvironmentInfoFromAPI() {
            console.log('üåç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê ENV: Attempting to fetch /admin/api/environment-info');
            
            fetch('/admin/api/environment-info')
                .then(response => {
                    console.log('üì° –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê ENV: environment-info response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(envData => {
                    console.log('üìä –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê ENV: environment-info data received:', envData);
                    updateEnvironmentInfo(envData);
                })
                .catch(error => {
                    console.error('‚ùå –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê ENV: Environment info fetch failed:', error);
                    console.error('‚ùå –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê ENV: This endpoint is missing - will use fallback data');
                    // Fallback –∫ —Å—Ç–∞—Ç–∏—á–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º
                    updateEnvironmentInfo({
                        platform: 'Koyeb',
                        javaVersion: '21',
                        springBootVersion: '3.4.5',
                        activeProfile: 'koyeb'
                    });
                });
        }
        
        // Initialize monitoring page
        document.addEventListener('DOMContentLoaded', function() {
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            const lastUpdateEl = document.getElementById('metrics-last-update');
            if (lastUpdateEl) {
                lastUpdateEl.textContent = 'Initializing...';
            }
            
            // –ù–û–í–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê: –ó–∞–ø—É—Å–∫–∞–µ–º SSE –¥–ª—è Performance Metrics
            console.log('üîå Initializing SSE-based Performance Metrics');
            initPerformanceSSE();
            
            // –û–±—ã—á–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (–Ω–µ Performance) –æ—Å—Ç–∞—é—Ç—Å—è –Ω–∞ HTTP
            updateSystemMetrics();
            refreshActivity();
            
            
            // Start activity auto-refresh
            monitoringActivityInterval = setInterval(function() {
                refreshActivity();
            }, 30000);
            
            // –°–∏—Å—Ç–µ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (–ù–ï Performance) –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∂–µ
            setInterval(function() {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ non-performance –º–µ—Ç—Ä–∏–∫–∏
                updateSystemMetricsExcludingPerformance();
            }, 15000); // –ö–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥ –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫
            
            // Performance Metrics —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ SSE (–∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
            // Fallback polling –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å SSE
            
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (monitoringActivityInterval) {
                clearInterval(monitoringActivityInterval);
            }
        });
    </script>
</th:block>
</html>
